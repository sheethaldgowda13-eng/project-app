<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Student Management System">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3R1ZGVudCBNYW5hZ2VtZW50IFN5c3RlbSIsInNob3J0X25hbWUiOiJTdHVkZW50TVMiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRmNDZlNSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbWxsZDBKdmVEMGlNQ0F3SURFME9DQXlPQ0lnWm1sc2JEMGlJelJqTkRabE9TSStQR05wY21Oc1pTQmplRDBpTmpRaUlHTjVQU0kyTkNJZ2NqMGlNalFpSUdacGJHdzlJaU5tWm1ZaVBqd3ZZMmx5WTJ4bFBqd3ZjM1puUGc9PSIsInR5cGUiOiJpbWFnZS9zdmcreG1sIiwic2l6ZXMiOiIxMjh4MTI4In1dfQ==">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; border-radius: 16px; padding: 14px 24px;
            color: white; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; width: 100%;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); 
        }
        
        .btn-primary:disabled { 
            opacity: 0.6; cursor: not-allowed; transform: none; 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%); 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-info { 
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary { 
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); 
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }
        
        .input-field {
            border: 2px solid #e5e7eb; border-radius: 16px;
            padding: 14px 18px; transition: all 0.3s ease; width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .input-field:focus {
            border-color: #667eea; outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }
        
        .input-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
        
        .error-text {
            color: #ef4444; font-size: 12px; margin-top: 6px;
            display: none; font-weight: 500;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease; margin-bottom: 20px;
        }
        
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); 
        }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex; justify-content: space-around; padding: 12px 8px 20px 8px;
            z-index: 1000; 
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            padding: 8px 12px; cursor: pointer; transition: all 0.3s ease;
            border-radius: 16px; min-width: 60px; position: relative;
        }
        
        .nav-item.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .nav-item:not(.active):hover { 
            background: rgba(102, 126, 234, 0.1); 
            transform: translateY(-2px);
        }
        
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        
        .main-content { 
            padding: 20px 16px 120px 16px; 
            min-height: 100vh;
        }
        
        .notification {
            position: fixed; top: 20px; left: 16px; right: 16px; z-index: 2000;
            padding: 16px 20px; border-radius: 16px; color: white;
            font-weight: 600; display: none; 
            animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
        }
        
        .notification.success { 
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%); 
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .notification.error { 
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); 
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none; justify-content: center;
            align-items: flex-end; z-index: 2000; padding: 0;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white; border-radius: 24px 24px 0 0; padding: 28px;
            width: 100%; max-height: 85vh; overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.2);
        }
        
        .stats-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); 
            gap: 16px; margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 16px; padding: 20px; text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        
        .table-container {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        .table-modern {
            width: 100%; border-collapse: collapse;
            min-width: 600px;
        }
        
        .table-modern th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 16px 12px; text-align: left; font-weight: 600;
            font-size: 14px; position: sticky; top: 0; z-index: 10;
        }
        
        .table-modern td { 
            padding: 16px 12px; border-bottom: 1px solid #f3f4f6; 
            font-size: 14px; white-space: nowrap;
        }
        
        .table-modern tr:hover { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); 
        }
        
        .badge {
            display: inline-block; padding: 6px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success { 
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%); 
            color: white; 
        }
        
        .badge-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); 
            color: white; 
        }
        
        .badge-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); 
            color: white; 
        }
        
        .badge-info { 
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); 
            color: white; 
        }
        
        .floating-btn {
            position: fixed; bottom: 140px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        }

        .floating-btn.active {
            transform: rotate(45deg);
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }

        .fab-menu {
            position: fixed;
            bottom: 220px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            animation: fabSlideIn 0.3s ease forwards;
            opacity: 0;
            transform: translateX(100px);
        }

        .fab-menu-item:nth-child(1) { animation-delay: 0.1s; }
        .fab-menu-item:nth-child(2) { animation-delay: 0.15s; }
        .fab-menu-item:nth-child(3) { animation-delay: 0.2s; }
        .fab-menu-item:nth-child(4) { animation-delay: 0.25s; }
        .fab-menu-item:nth-child(5) { animation-delay: 0.3s; }

        .fab-item-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .fab-item-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .fab-item-student {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        .fab-item-bulk {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }

        .fab-item-attendance {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        .fab-item-grade {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        .fab-item-approval {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }

        .fab-item-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .fab-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        @keyframes fabSlideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .install-banner {
            position: fixed; top: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 16px; text-center;
            font-size: 14px; font-weight: 600; z-index: 1001;
            display: none; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .install-banner button {
            background: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 8px 16px; border-radius: 12px;
            margin: 0 6px; cursor: pointer; font-size: 12px;
            font-weight: 600; transition: all 0.3s ease;
        }

        .install-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .ai-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white; padding: 3px 8px; border-radius: 12px;
            font-size: 9px; font-weight: bold; margin-left: 6px;
            animation: pulse 2s infinite;
        }

        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 20px; padding: 20px;
            margin-bottom: 20px; position: relative; overflow: hidden;
        }

        .prediction-card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .back-btn {
            position: fixed; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); border: none;
            border-radius: 50%; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            color: #667eea; font-size: 18px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: white; 
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            padding-left: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 14px 18px 14px 50px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 16px;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .export-btn {
            position: fixed;
            bottom: 210px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
        }

        .link-button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .link-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #5a67d8;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (min-width: 768px) {
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .modal { align-items: center; padding: 20px; }
            .modal-content { 
                border-radius: 24px; max-width: 600px; 
                max-height: 80vh; animation: none;
            }
            .main-content { padding: 40px; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Install Banner -->
    <div id="installBanner" class="install-banner">
        <i class="fas fa-mobile-alt mr-2"></i>
        Install Student Management System for the best mobile experience!
        <button onclick="installApp()" id="installBtn">
            <i class="fas fa-download mr-1"></i>Install
        </button>
        <button onclick="dismissInstall()">
            <i class="fas fa-times mr-1"></i>Later
        </button>
    </div>

    <!-- Back Button -->
    <button id="backButton" class="back-btn" onclick="goBack()" style="display: none;">
        <i class="fas fa-arrow-left"></i>
    </button>

    <!-- Export Button -->
    <button id="exportButton" class="export-btn" onclick="exportData()" style="display: none;" title="Export Data">
        <i class="fas fa-download"></i>
    </button>

    <!-- Notifications -->
    <div id="successNotification" class="notification success">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="successMessage">Success!</span>
    </div>
    <div id="errorNotification" class="notification error">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorMessage">Error!</span>
    </div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="card w-full max-w-md">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-graduation-cap text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">SREE SIDDRAMESHWARA POLYTECHNIC TIPTUR</h1>
                    <p class="text-gray-600 text-sm">Student Management System</p>
                    <p class="text-gray-500 text-xs">Diploma Management Portal</p>
                </div>
                
                <form id="loginFormElement" onsubmit="handleLogin(event)">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Username/Email *</label>
                        <input type="text" id="loginUsername" required class="input-field" placeholder="Enter username or email">
                        <div class="error-text" id="loginUsernameError">Please enter a valid username or email</div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Password *</label>
                        <input type="password" id="loginPassword" required class="input-field" placeholder="Enter password" minlength="6">
                        <div class="error-text" id="loginPasswordError">Password must be at least 6 characters</div>
                    </div>
                    
                    <button type="submit" class="btn-primary mb-6" id="loginButton">
                        <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                    </button>
                </form>
                
                <div class="text-center mb-6">
                    <button class="link-button" onclick="showRegister()">
                        Create New Account
                    </button>
                </div>
                
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200">
                    <h4 class="font-semibold text-indigo-800 mb-3">🎓 Demo Accounts:</h4>
                    <div class="text-xs text-indigo-700 space-y-2">
                        <div><strong>Student:</strong> student@demo.com / student123</div>
                        <div><strong>Admin:</strong> admin@demo.com / admin123</div>
                    </div>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Account</h1>
                    <p class="text-gray-600">Join Student Management System</p>
                </div>
                
                <form id="registerFormElement" onsubmit="handleRegister(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="regName" required class="input-field" placeholder="Enter full name" minlength="2">
                        <div class="error-text" id="regNameError">Name must be at least 2 characters</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                        <input type="email" id="regEmail" required class="input-field" placeholder="Enter email">
                        <div class="error-text" id="regEmailError">Please enter a valid email address</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Role *</label>
                        <select id="regRole" required class="input-field" onchange="toggleCourseField()">
                            <option value="">Select Role</option>
                            <option value="student">Student</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <div class="error-text" id="regRoleError">Please select a role</div>
                    </div>
                    
                    <div id="courseField" class="mb-4" style="display: none;">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Course *</label>
                        <select id="regCourse" class="input-field">
                            <option value="">Select Course</option>
                            <option value="computer-science">Computer Science & Engineering</option>
                            <option value="mechanical">Mechanical Engineering</option>
                            <option value="civil">Civil Engineering</option>
                            <option value="electrical">Electrical & Electronics Engineering</option>
                            <option value="electronics-communication">Electronics & Communication Engineering</option>
                            <option value="automobile">Automobile Engineering</option>
                            <option value="textile">Textile Technology</option>
                            <option value="information-science">Information Science & Engineering</option>
                        </select>
                        <div class="error-text" id="regCourseError">Please select a course</div>
                    </div>
                    
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Password *</label>
                        <input type="password" id="regPassword" required class="input-field" placeholder="Create password" minlength="6">
                        <div class="error-text" id="regPasswordError">Password must be at least 6 characters</div>
                    </div>
                    
                    <button type="submit" class="btn-primary mb-6" id="registerButton">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </button>
                </form>
                
                <div class="text-center">
                    <button class="link-button" onclick="showLogin()">
                        Back to Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <div class="bg-white/90 backdrop-blur-lg p-4 shadow-sm border-b border-white/20 sticky top-0 z-50">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-800" id="pageTitle">Dashboard</h1>
                    <p class="text-sm text-gray-600" id="pageSubtitle">Welcome back!</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <p class="font-semibold text-gray-800 text-sm" id="headerUserName">User</p>
                        <p class="text-xs text-gray-600" id="headerUserRole">Role</p>
                    </div>
                    <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-user text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="main-content" id="contentArea">
            <!-- Content will be populated by JavaScript -->
        </div>

        <!-- Floating Action Button (Admin Only) -->
        <button id="fabButton" class="floating-btn" onclick="toggleFabMenu()" style="display: none;">
            <i class="fas fa-plus" id="fabIcon"></i>
        </button>

        <!-- FAB Menu -->
        <div id="fabMenu" class="fab-menu" style="display: none;">
            <div class="fab-menu-item" onclick="openModal('addStudentModal'); closeFabMenu();">
                <div class="fab-item-btn fab-item-student">
                    <i class="fas fa-user-plus"></i>
                </div>
                <span class="fab-item-label">Add Student</span>
            </div>
            <div class="fab-menu-item" onclick="showBulkActions(); closeFabMenu();">
                <div class="fab-item-btn fab-item-bulk">
                    <i class="fas fa-users-cog"></i>
                </div>
                <span class="fab-item-label">Bulk Actions</span>
            </div>
            <div class="fab-menu-item" onclick="showQuickAttendance(); closeFabMenu();">
                <div class="fab-item-btn fab-item-attendance">
                    <i class="fas fa-user-check"></i>
                </div>
                <span class="fab-item-label">Quick Attendance</span>
            </div>
            <div class="fab-menu-item" onclick="showQuickGrade(); closeFabMenu();">
                <div class="fab-item-btn fab-item-grade">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="fab-item-label">Quick Grade</span>
            </div>
            <div class="fab-menu-item" onclick="showPendingApprovals(); closeFabMenu();">
                <div class="fab-item-btn fab-item-approval">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="fab-item-label">Approvals</span>
            </div>
        </div>

        <!-- FAB Menu Overlay -->
        <div id="fabOverlay" class="fab-overlay" onclick="closeFabMenu()" style="display: none;"></div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav">
            <!-- Navigation items will be populated by JavaScript -->
        </div>
    </div>

    <!-- Modals -->
    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-sign-out-alt text-3xl text-white"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Confirm Logout</h2>
                <p class="text-gray-600">Are you sure you want to logout?</p>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 mt-1"></i>
                    <div class="text-sm text-yellow-800">
                        <p class="font-semibold mb-1">Before you logout:</p>
                        <ul class="list-disc ml-4 space-y-1">
                            <li>All unsaved changes will be lost</li>
                            <li>You'll need to login again to access your account</li>
                            <li>Any ongoing activities will be interrupted</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="cancelLogout()" class="btn-secondary">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button onclick="confirmLogout()" class="btn-danger" id="confirmLogoutButton">
                    <i class="fas fa-sign-out-alt mr-2"></i>Yes, Logout
                </button>
            </div>
            
            <div class="mt-4 text-center">
                <button onclick="logoutAndClearData()" class="link-button text-red-600 hover:text-red-800">
                    <i class="fas fa-trash mr-1"></i>Logout & Clear All Data
                </button>
            </div>
        </div>
    </div>

    <!-- Session Timeout Warning Modal -->
    <div id="sessionTimeoutModal" class="modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-clock text-3xl text-white"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Session Timeout Warning</h2>
                <p class="text-gray-600">Your session will expire soon due to inactivity</p>
            </div>
            
            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-center">
                    <i class="fas fa-hourglass-half text-orange-600 mr-3"></i>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-800" id="timeoutCountdown">60</div>
                        <div class="text-sm text-orange-700">seconds remaining</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <p class="text-sm text-gray-600">
                    Click "Stay Logged In" to continue your session, or you'll be automatically logged out for security.
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="extendSession()" class="btn-primary" id="extendSessionButton">
                    <i class="fas fa-refresh mr-2"></i>Stay Logged In
                </button>
                <button onclick="confirmLogout()" class="btn-secondary">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout Now
                </button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Add New Student</h2>
                <button onclick="closeModal('addStudentModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addStudentForm" onsubmit="addStudent(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="studentName" required class="input-field" placeholder="Enter full name" minlength="2">
                        <div class="error-text" id="studentNameError">Name must be at least 2 characters</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                        <input type="email" id="studentEmail" required class="input-field" placeholder="Enter email">
                        <div class="error-text" id="studentEmailError">Please enter a valid email address</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Course *</label>
                        <select id="studentCourse" required class="input-field">
                            <option value="">Select Course</option>
                            <option value="computer-science">Computer Science & Engineering</option>
                            <option value="mechanical">Mechanical Engineering</option>
                            <option value="civil">Civil Engineering</option>
                            <option value="electrical">Electrical & Electronics Engineering</option>
                            <option value="electronics-communication">Electronics & Communication Engineering</option>
                            <option value="automobile">Automobile Engineering</option>
                            <option value="textile">Textile Technology</option>
                            <option value="information-science">Information Science & Engineering</option>
                        </select>
                        <div class="error-text" id="studentCourseError">Please select a course</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Semester *</label>
                        <select id="studentSemester" required class="input-field">
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                        </select>
                        <div class="error-text" id="studentSemesterError">Please select a semester</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Phone *</label>
                        <input type="tel" id="studentPhone" required class="input-field" placeholder="Enter phone number" pattern="[0-9]{10}">
                        <div class="error-text" id="studentPhoneError">Please enter a valid 10-digit phone number</div>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button type="button" onclick="closeModal('addStudentModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="addStudentButton">
                        <i class="fas fa-plus mr-2"></i>Add Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Edit Student</h2>
                <button onclick="closeModal('editStudentModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editStudentForm" onsubmit="updateStudent(event)">
                <input type="hidden" id="editStudentId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="editStudentName" required class="input-field" placeholder="Enter full name" minlength="2">
                        <div class="error-text" id="editStudentNameError">Name must be at least 2 characters</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                        <input type="email" id="editStudentEmail" required class="input-field" placeholder="Enter email">
                        <div class="error-text" id="editStudentEmailError">Please enter a valid email address</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Course *</label>
                        <select id="editStudentCourse" required class="input-field">
                            <option value="">Select Course</option>
                            <option value="computer-science">Computer Science & Engineering</option>
                            <option value="mechanical">Mechanical Engineering</option>
                            <option value="civil">Civil Engineering</option>
                            <option value="electrical">Electrical & Electronics Engineering</option>
                            <option value="electronics-communication">Electronics & Communication Engineering</option>
                            <option value="automobile">Automobile Engineering</option>
                            <option value="textile">Textile Technology</option>
                            <option value="information-science">Information Science & Engineering</option>
                        </select>
                        <div class="error-text" id="editStudentCourseError">Please select a course</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Semester *</label>
                        <select id="editStudentSemester" required class="input-field">
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                        </select>
                        <div class="error-text" id="editStudentSemesterError">Please select a semester</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="editStudentPhone" class="input-field" placeholder="Enter phone number" pattern="[0-9]{10}">
                        <div class="error-text" id="editStudentPhoneError">Please enter a valid 10-digit phone number</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                        <select id="editStudentStatus" required class="input-field">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                            <option value="graduated">Graduated</option>
                        </select>
                        <div class="error-text" id="editStudentStatusError">Please select a status</div>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button type="button" onclick="closeModal('editStudentModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="updateStudentButton">
                        <i class="fas fa-save mr-2"></i>Update Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Edit Attendance</h2>
                <button onclick="closeModal('editAttendanceModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editAttendanceForm" onsubmit="updateAttendance(event)">
                <input type="hidden" id="editAttendanceId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Student</label>
                        <input type="text" id="editAttendanceStudentName" class="input-field" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                        <select id="editAttendanceSubject" required class="input-field">
                            <option value="">Select Subject</option>
                            ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                        </select>
                        <div class="error-text" id="editAttendanceSubjectError">Please select a subject</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" id="editAttendanceDate" required class="input-field">
                        <div class="error-text" id="editAttendanceDateError">Please select a date</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                        <select id="editAttendanceStatus" required class="input-field">
                            <option value="">Select Status</option>
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                        </select>
                        <div class="error-text" id="editAttendanceStatusError">Please select a status</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                        <input type="time" id="editAttendanceTime" class="input-field">
                    </div>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button type="button" onclick="closeModal('editAttendanceModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="updateAttendanceButton">
                        <i class="fas fa-save mr-2"></i>Update Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Grade Modal -->
    <div id="editGradeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Edit Grade</h2>
                <button onclick="closeModal('editGradeModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editGradeForm" onsubmit="updateGrade(event)">
                <input type="hidden" id="editGradeId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Student</label>
                        <input type="text" id="editGradeStudentName" class="input-field" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                        <select id="editGradeSubject" required class="input-field">
                            <option value="">Select Subject</option>
                            ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                        </select>
                        <div class="error-text" id="editGradeSubjectError">Please select a subject</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Exam Type *</label>
                        <select id="editGradeExamType" required class="input-field">
                            <option value="">Select Exam Type</option>
                            <option value="internal">Internal Assessment</option>
                            <option value="midterm">Mid-term Exam</option>
                            <option value="final">Final Exam</option>
                            <option value="practical">Practical Exam</option>
                            <option value="assignment">Assignment</option>
                        </select>
                        <div class="error-text" id="editGradeExamTypeError">Please select an exam type</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" id="editGradeDate" required class="input-field">
                        <div class="error-text" id="editGradeDateError">Please select a date</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Total Marks *</label>
                        <input type="number" id="editGradeTotalMarks" required class="input-field" min="1" max="1000">
                        <div class="error-text" id="editGradeTotalMarksError">Please enter valid total marks</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Obtained Marks *</label>
                        <input type="number" id="editGradeObtainedMarks" required class="input-field" min="0">
                        <div class="error-text" id="editGradeObtainedMarksError">Please enter valid obtained marks</div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Verification Status</label>
                        <select id="editGradeVerified" class="input-field">
                            <option value="true">Verified</option>
                            <option value="false">Pending Verification</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8">
                    <button type="button" onclick="closeModal('editGradeModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="updateGradeButton">
                        <i class="fas fa-save mr-2"></i>Update Grade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkActionsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Bulk Actions</h2>
                <button onclick="closeModal('bulkActionsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Student Selection -->
                <div>
                    <h3 class="font-semibold text-lg mb-4">Select Students</h3>
                    <div class="mb-4">
                        <button onclick="selectAllStudents()" class="btn-info text-sm px-4 py-2 mr-2">
                            <i class="fas fa-check-square mr-2"></i>Select All
                        </button>
                        <button onclick="deselectAllStudents()" class="btn-secondary text-sm px-4 py-2">
                            <i class="fas fa-square mr-2"></i>Deselect All
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto border rounded-xl p-4 bg-gray-50">
                        <div id="bulkStudentsList">
                            ${students.map(student => `
                                <label class="flex items-center p-2 hover:bg-white rounded-lg cursor-pointer">
                                    <input type="checkbox" class="bulk-student-checkbox mr-3" value="${student.id}">
                                    <div>
                                        <div class="font-semibold text-sm">${student.name}</div>
                                        <div class="text-xs text-gray-600">${student.id} • ${getCourseName(student.course)}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div>
                    <h3 class="font-semibold text-lg mb-4">Choose Action</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="bulkMarkAttendance()" class="btn-success text-sm py-3">
                            <i class="fas fa-user-check mr-2"></i>Mark Attendance
                        </button>
                        <button onclick="bulkChangeStatus()" class="btn-warning text-sm py-3">
                            <i class="fas fa-user-cog mr-2"></i>Change Status
                        </button>
                        <button onclick="bulkSendNotification()" class="btn-info text-sm py-3">
                            <i class="fas fa-bell mr-2"></i>Send Notification
                        </button>
                        <button onclick="bulkExportData()" class="btn-primary text-sm py-3">
                            <i class="fas fa-download mr-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Attendance Modal -->
    <div id="quickAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Quick Attendance</h2>
                <button onclick="closeModal('quickAttendanceModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form onsubmit="submitQuickAttendance(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                        <select id="quickAttendanceSubject" required class="input-field">
                            <option value="">Select Subject</option>
                            ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" id="quickAttendanceDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold text-lg mb-4">Mark Attendance for All Students</h3>
                    <div class="max-h-64 overflow-y-auto border rounded-xl p-4 bg-gray-50">
                        <div id="quickAttendanceList">
                            ${students.filter(s => s.status === 'active').map(student => `
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-2">
                                    <div>
                                        <div class="font-semibold text-sm">${student.name}</div>
                                        <div class="text-xs text-gray-600">${student.id}</div>
                                    </div>
                                    <select class="quick-attendance-status input-field text-sm" data-student-id="${student.id}">
                                        <option value="present">Present</option>
                                        <option value="absent">Absent</option>
                                        <option value="late">Late</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" onclick="closeModal('quickAttendanceModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="submitQuickAttendanceButton">
                        <i class="fas fa-check mr-2"></i>Submit Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Grade Modal -->
    <div id="quickGradeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Quick Grade Entry</h2>
                <button onclick="closeModal('quickGradeModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form onsubmit="submitQuickGrade(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                        <select id="quickGradeSubject" required class="input-field">
                            <option value="">Select Subject</option>
                            ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Exam Type *</label>
                        <select id="quickGradeExamType" required class="input-field">
                            <option value="">Select Exam Type</option>
                            <option value="internal">Internal Assessment</option>
                            <option value="midterm">Mid-term Exam</option>
                            <option value="final">Final Exam</option>
                            <option value="practical">Practical Exam</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                        <input type="date" id="quickGradeDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Total Marks *</label>
                        <input type="number" id="quickGradeTotalMarks" required class="input-field" min="1" max="1000" placeholder="e.g., 100">
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold text-lg mb-4">Enter Grades for Students</h3>
                    <div class="max-h-64 overflow-y-auto border rounded-xl p-4 bg-gray-50">
                        <div id="quickGradeList">
                            ${students.filter(s => s.status === 'active').map(student => `
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-2">
                                    <div>
                                        <div class="font-semibold text-sm">${student.name}</div>
                                        <div class="text-xs text-gray-600">${student.id}</div>
                                    </div>
                                    <input type="number" class="quick-grade-marks input-field text-sm w-24" 
                                           data-student-id="${student.id}" min="0" placeholder="Marks">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" onclick="closeModal('quickGradeModal')" class="btn-secondary">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="submitQuickGradeButton">
                        <i class="fas fa-check mr-2"></i>Submit Grades
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pending Approvals Modal -->
    <div id="pendingApprovalsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Pending Approvals</h2>
                <button onclick="closeModal('pendingApprovalsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Pending Grades -->
                <div>
                    <h3 class="font-semibold text-lg mb-4">📊 Pending Grade Verifications</h3>
                    <div class="max-h-64 overflow-y-auto">
                        <div id="pendingGradesList">
                            ${marks.filter(m => m.selfReported && !m.verified).map(grade => {
                                const student = students.find(s => s.id === grade.studentId);
                                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                                return `
                                    <div class="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl mb-3 border border-yellow-200">
                                        <div class="flex-1">
                                            <div class="font-semibold text-sm">${student ? student.name : 'Unknown'}</div>
                                            <div class="text-xs text-gray-600">${getSubjectName(grade.subject)} • ${formatExamType(grade.examType)}</div>
                                            <div class="text-sm font-bold text-purple-600">${grade.obtainedMarks}/${grade.totalMarks} (${percentage}%)</div>
                                            <div class="text-xs text-gray-500">Reported on ${formatDate(grade.date)}</div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="approveGrade(${grade.id})" class="btn-success text-xs px-3 py-2">
                                                <i class="fas fa-check mr-1"></i>Approve
                                            </button>
                                            <button onclick="rejectGrade(${grade.id})" class="btn-danger text-xs px-3 py-2">
                                                <i class="fas fa-times mr-1"></i>Reject
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('') || '<p class="text-gray-500 text-center py-8">No pending grade verifications</p>'}
                        </div>
                    </div>
                </div>

                <!-- Pending Students (if any need approval) -->
                <div>
                    <h3 class="font-semibold text-lg mb-4">👥 Student Status Management</h3>
                    <div class="max-h-64 overflow-y-auto">
                        <div id="studentApprovalsList">
                            ${students.filter(s => s.status === 'inactive' || s.status === 'suspended').map(student => `
                                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl mb-3 border border-red-200">
                                    <div class="flex-1">
                                        <div class="font-semibold text-sm">${student.name}</div>
                                        <div class="text-xs text-gray-600">${student.id} • ${getCourseName(student.course)}</div>
                                        <div class="text-sm">
                                            <span class="badge ${student.status === 'inactive' ? 'badge-secondary' : 'badge-danger'}">${student.status.toUpperCase()}</span>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="approveStudent('${student.id}')" class="btn-success text-xs px-3 py-2">
                                            <i class="fas fa-user-check mr-1"></i>Activate
                                        </button>
                                        <button onclick="viewStudent('${student.id}'); closeModal('pendingApprovalsModal');" class="btn-info text-xs px-3 py-2">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </button>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-8">All students are active</p>'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let students = [];
        let attendance = [];
        let marks = [];
        let users = [];
        let navigationHistory = [];
        let deferredPrompt = null;
        let currentFilter = 'all';
        let searchQuery = '';
        let sessionTimeout = null;
        let lastActivity = Date.now();
        let isSessionWarningShown = false;

        // Diploma Subjects by Semester
        const subjects = {
            1: [
                { value: 'fundamental-computer', name: 'Fundamental of Computer' },
                { value: 'maths', name: 'Mathematics' },
                { value: 'it-skills', name: 'IT Skills' },
                { value: 'statistical-analysis', name: 'Statistical Analysis' },
                { value: 'environmental-evs', name: 'Environmental EVS' }
            ],
            2: [
                { value: 'syllabus-pending', name: 'Syllabus Update Pending - Contact Admin' }
            ],
            3: [
                { value: 'computer-hardware', name: 'Computer Hardware Maintenance and Administration' },
                { value: 'python', name: 'Python' },
                { value: 'computer-network', name: 'Computer Network' },
                { value: 'database-management', name: 'Database Management System' },
                { value: 'kannada', name: 'Kannada' }
            ],
            4: [
                { value: 'software-engineering', name: 'Software Engineering Principles and Practice' },
                { value: 'data-structure-python', name: 'Data Structure in Python' },
                { value: 'java', name: 'Java' },
                { value: 'operating-system', name: 'Operating System' },
                { value: 'indian-constitution', name: 'Indian Constitution' }
            ],
            5: [
                { value: 'ai-ml', name: 'AI and ML' }
            ],
            6: [
                { value: 'project', name: 'Project' }
            ]
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            loadData();
            if (!users.length) {
                initializeDemoData();
                saveData();
            }
            
            // Set today's date for forms
            const today = new Date().toISOString().split('T')[0];
            const dateFields = ['attendanceDate', 'marksDate', 'selfGradesDate'];
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = today;
            });
            
            // Check if user is already logged in
            if (currentUser) {
                showMainApp();
                initializeSessionManagement();
            } else {
                // Show install banner if not dismissed
                const installDismissed = localStorage.getItem('installDismissed');
                if (!installDismissed) {
                    showInstallBanner();
                }
            }

            // PWA Install Event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOw==')
                    .catch(err => console.log('SW registration failed'));
            }

            // Add activity listeners for session management
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, updateLastActivity, true);
            });
        });

        // Install App Functions
        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner && !localStorage.getItem('installDismissed')) {
                banner.style.display = 'block';
                // Adjust auth screen margin
                document.getElementById('authScreen').style.marginTop = '60px';
            }
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showSuccess('App installed successfully! 🎉');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            } else {
                // Fallback for browsers that don't support PWA
                showSuccess('Add this page to your home screen for better experience!');
                dismissInstall();
            }
        }

        function dismissInstall() {
            document.getElementById('installBanner').style.display = 'none';
            document.getElementById('authScreen').style.marginTop = '0';
            localStorage.setItem('installDismissed', 'true');
        }

        // Validation Functions
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePhone(phone) {
            const phoneRegex = /^[0-9]{10}$/;
            return phoneRegex.test(phone);
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (field && errorDiv) {
                field.classList.add('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');
            
            if (field && errorDiv) {
                field.classList.remove('error');
                errorDiv.style.display = 'none';
            }
        }

        function clearAllErrors(formId) {
            const form = document.getElementById(formId);
            if (form) {
                const errorMessages = form.querySelectorAll('.error-text');
                const errorFields = form.querySelectorAll('.error');
                
                errorMessages.forEach(error => error.style.display = 'none');
                errorFields.forEach(field => field.classList.remove('error'));
            }
        }

        // Notification Functions
        function showSuccess(message) {
            const notification = document.getElementById('successNotification');
            const messageSpan = document.getElementById('successMessage');
            messageSpan.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        function showError(message) {
            const notification = document.getElementById('errorNotification');
            const messageSpan = document.getElementById('errorMessage');
            messageSpan.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Data Storage Functions
        function saveData() {
            try {
                localStorage.setItem('studentMS_users', JSON.stringify(users));
                localStorage.setItem('studentMS_students', JSON.stringify(students));
                localStorage.setItem('studentMS_attendance', JSON.stringify(attendance));
                localStorage.setItem('studentMS_marks', JSON.stringify(marks));
                localStorage.setItem('studentMS_currentUser', JSON.stringify(currentUser));
                return true;
            } catch (error) {
                console.log('Storage not available');
                return false;
            }
        }

        function loadData() {
            try {
                const savedUsers = localStorage.getItem('studentMS_users');
                const savedStudents = localStorage.getItem('studentMS_students');
                const savedAttendance = localStorage.getItem('studentMS_attendance');
                const savedMarks = localStorage.getItem('studentMS_marks');
                const savedCurrentUser = localStorage.getItem('studentMS_currentUser');

                if (savedUsers) users = JSON.parse(savedUsers);
                if (savedStudents) students = JSON.parse(savedStudents);
                if (savedAttendance) attendance = JSON.parse(savedAttendance);
                if (savedMarks) marks = JSON.parse(savedMarks);
                if (savedCurrentUser) currentUser = JSON.parse(savedCurrentUser);

                return savedUsers !== null;
            } catch (error) {
                console.log('Error loading data');
                return false;
            }
        }

        // Generate automatic student ID with sequential numbering starting from 485CS2301
        function generateStudentId(course) {
            const coursePrefixes = {
                'computer-science': 'CS',
                'mechanical': 'ME',
                'civil': 'CE',
                'electrical': 'EE',
                'electronics-communication': 'EC',
                'automobile': 'AU',
                'textile': 'TX',
                'information-science': 'IS'
            };
            
            const prefix = '485' + (coursePrefixes[course] || 'CS') + '23';
            
            // Get all existing IDs with this prefix and extract numbers
            const existingNumbers = students
                .filter(s => s.id.startsWith(prefix))
                .map(s => {
                    const numberPart = s.id.substring(prefix.length);
                    return parseInt(numberPart);
                })
                .filter(num => !isNaN(num))
                .sort((a, b) => a - b);
            
            // Find the next sequential number starting from 01
            let nextNumber = 1;
            for (let i = 0; i < existingNumbers.length; i++) {
                if (existingNumbers[i] === nextNumber) {
                    nextNumber++;
                } else {
                    break;
                }
            }
            
            return prefix + String(nextNumber).padStart(2, '0');
        }

        // Initialize demo data
        function initializeDemoData() {
            users = [
                { 
                    id: 1, 
                    name: 'Demo Student', 
                    email: 'student@demo.com', 
                    password: 'student123', 
                    role: 'student', 
                    course: 'computer-science', 
                    semester: 3,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 2, 
                    name: 'Demo Admin', 
                    email: 'admin@demo.com', 
                    password: 'admin123', 
                    role: 'admin',
                    createdAt: new Date().toISOString()
                }
            ];

            students = [
                { 
                    id: '485CS2301', 
                    name: 'Demo Student', 
                    email: 'student@demo.com', 
                    course: 'computer-science', 
                    semester: 3, 
                    phone: '9876543210', 
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                { 
                    id: '485CS2302', 
                    name: 'Priya Sharma', 
                    email: 'priya@student.com', 
                    course: 'computer-science', 
                    semester: 1, 
                    phone: '9876543211', 
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                { 
                    id: '485CS2303', 
                    name: 'Amit Kumar', 
                    email: 'amit@student.com', 
                    course: 'computer-science', 
                    semester: 4, 
                    phone: '9876543212', 
                    status: 'active',
                    createdAt: new Date().toISOString()
                },
                { 
                    id: '485ME2301', 
                    name: 'Sneha Patel', 
                    email: 'sneha@student.com', 
                    course: 'mechanical', 
                    semester: 2, 
                    phone: '9876543213', 
                    status: 'active',
                    createdAt: new Date().toISOString()
                }
            ];

            const today = new Date().toISOString().split('T')[0];
            
            attendance = [
                { 
                    id: 1,
                    studentId: '485CS2301', 
                    date: today, 
                    subject: 'python', 
                    status: 'present',
                    time: '09:30',
                    markedBy: 'student@demo.com',
                    selfMarked: true,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 2,
                    studentId: '485CS2302', 
                    date: today, 
                    subject: 'maths', 
                    status: 'present',
                    time: '10:15',
                    markedBy: 'admin@demo.com',
                    selfMarked: false,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 3,
                    studentId: '485CS2303', 
                    date: today, 
                    subject: 'java', 
                    status: 'absent',
                    time: null,
                    markedBy: 'admin@demo.com',
                    selfMarked: false,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 4,
                    studentId: '485CS2301', 
                    date: today, 
                    subject: 'computer-hardware', 
                    status: 'late',
                    time: '11:45',
                    markedBy: 'student@demo.com',
                    selfMarked: true,
                    createdAt: new Date().toISOString()
                }
            ];

            marks = [
                { 
                    id: 1,
                    studentId: '485CS2301', 
                    subject: 'python', 
                    examType: 'midterm', 
                    totalMarks: 100, 
                    obtainedMarks: 85, 
                    date: today,
                    addedBy: 'student@demo.com',
                    selfReported: true,
                    verified: false,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 2,
                    studentId: '485CS2302', 
                    subject: 'maths', 
                    examType: 'internal', 
                    totalMarks: 50, 
                    obtainedMarks: 42, 
                    date: today,
                    addedBy: 'admin@demo.com',
                    selfReported: false,
                    verified: true,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 3,
                    studentId: '485CS2303', 
                    subject: 'java', 
                    examType: 'final', 
                    totalMarks: 100, 
                    obtainedMarks: 78, 
                    date: today,
                    addedBy: 'admin@demo.com',
                    selfReported: false,
                    verified: true,
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 4,
                    studentId: '485CS2301', 
                    subject: 'computer-hardware', 
                    examType: 'practical', 
                    totalMarks: 50, 
                    obtainedMarks: 45, 
                    date: today,
                    addedBy: 'admin@demo.com',
                    selfReported: false,
                    verified: true,
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            clearAllErrors('loginFormElement');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            let hasErrors = false;
            
            // Username validation
            if (!username) {
                showFieldError('loginUsername', 'Username or email is required');
                hasErrors = true;
            } else if (username.length < 3) {
                showFieldError('loginUsername', 'Username must be at least 3 characters');
                hasErrors = true;
            } else if (username.includes('@') && !validateEmail(username)) {
                showFieldError('loginUsername', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            // Password validation
            if (!password) {
                showFieldError('loginPassword', 'Password is required');
                hasErrors = true;
            } else if (password.length < 6) {
                showFieldError('loginPassword', 'Password must be at least 6 characters');
                hasErrors = true;
            } else if (!/(?=.*[a-zA-Z])(?=.*[0-9])/.test(password)) {
                showFieldError('loginPassword', 'Password must contain both letters and numbers');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const loginButton = document.getElementById('loginButton');
            loginButton.disabled = true;
            loginButton.innerHTML = '<div class="loading-spinner mr-2"></div>Signing In...';
            
            setTimeout(() => {
                const user = users.find(u => 
                    (u.email.toLowerCase() === username.toLowerCase() || 
                     u.name.toLowerCase() === username.toLowerCase()) && 
                    u.password === password
                );

                if (user) {
                    currentUser = { ...user };
                    delete currentUser.password;
                    saveData();
                    showSuccess(`Welcome back, ${user.name}! 🎉`);
                    showMainApp();
                } else {
                    showError('Invalid credentials! Please check your username and password.');
                }
                
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Sign In';
            }, 1500);
        }

        function handleRegister(event) {
            event.preventDefault();
            clearAllErrors('registerFormElement');
            
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const role = document.getElementById('regRole').value;
            const course = document.getElementById('regCourse').value;
            const password = document.getElementById('regPassword').value;
            
            let hasErrors = false;
            
            if (!name || name.length < 2) {
                showFieldError('regName', 'Name must be at least 2 characters');
                hasErrors = true;
            }
            
            if (!email || !validateEmail(email)) {
                showFieldError('regEmail', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            if (users.find(u => u.email.toLowerCase() === email)) {
                showFieldError('regEmail', 'Email already exists! Please use a different email.');
                hasErrors = true;
            }
            
            if (!role) {
                showFieldError('regRole', 'Please select a role');
                hasErrors = true;
            }
            
            if (role === 'student' && !course) {
                showFieldError('regCourse', 'Please select a course');
                hasErrors = true;
            }
            
            if (!password || password.length < 6) {
                showFieldError('regPassword', 'Password must be at least 6 characters');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const registerButton = document.getElementById('registerButton');
            registerButton.disabled = true;
            registerButton.innerHTML = '<div class="loading-spinner mr-2"></div>Creating Account...';
            
            setTimeout(() => {
                const newUser = {
                    id: users.length + 1,
                    name,
                    email,
                    password,
                    role,
                    course: role === 'student' ? course : null,
                    semester: role === 'student' ? 1 : null,
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                
                if (role === 'student') {
                    const studentId = generateStudentId();
                    
                    students.push({
                        id: studentId,
                        name,
                        email,
                        course,
                        semester: 1,
                        phone: '',
                        status: 'active',
                        createdAt: new Date().toISOString()
                    });
                }

                saveData();
                showSuccess(`Account created successfully! ${role === 'student' ? 'Student ID: ' + generateStudentId() : ''}`);
                showLogin();
                
                registerButton.disabled = false;
                registerButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Create Account';
                
                document.getElementById('registerFormElement').reset();
                document.getElementById('courseField').style.display = 'none';
            }, 2000);
        }

        function showRegister() {
            console.log('showRegister function called');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginForm && registerForm) {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                clearAllErrors('loginFormElement');
                console.log('Successfully switched to register form');
            } else {
                console.error('Could not find login or register forms');
            }
        }

        function showLogin() {
            console.log('showLogin function called');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginForm && registerForm) {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                clearAllErrors('registerFormElement');
                console.log('Successfully switched to login form');
            }
        }

        function toggleCourseField() {
            const role = document.getElementById('regRole').value;
            const courseField = document.getElementById('courseField');
            const courseSelect = document.getElementById('regCourse');
            
            if (role === 'student') {
                courseField.style.display = 'block';
                courseSelect.required = true;
            } else {
                courseField.style.display = 'none';
                courseSelect.required = false;
                courseSelect.value = '';
            }
            clearFieldError('regRole');
        }

        function logout() {
            // Show logout confirmation modal instead of simple confirm
            openModal('logoutModal');
        }

        function cancelLogout() {
            closeModal('logoutModal');
        }

        function confirmLogout() {
            const confirmButton = document.getElementById('confirmLogoutButton');
            confirmButton.disabled = true;
            confirmButton.innerHTML = '<div class="loading-spinner mr-2"></div>Logging out...';
            
            setTimeout(() => {
                performLogout(false);
                confirmButton.disabled = false;
                confirmButton.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Yes, Logout';
            }, 1500);
        }

        function logoutAndClearData() {
            const confirmClear = confirm('⚠️ WARNING: This will permanently delete ALL data including students, grades, and attendance records. This action cannot be undone!\n\nAre you absolutely sure?');
            
            if (confirmClear) {
                const doubleConfirm = confirm('🚨 FINAL WARNING: You are about to delete ALL data permanently. Type "DELETE" in the next prompt to confirm.');
                
                if (doubleConfirm) {
                    const userInput = prompt('Type "DELETE" to confirm permanent data deletion:');
                    
                    if (userInput === 'DELETE') {
                        performLogout(true);
                        showSuccess('All data cleared and logged out successfully! 🗑️');
                    } else {
                        showError('Data deletion cancelled - incorrect confirmation text');
                    }
                } else {
                    showError('Data deletion cancelled');
                }
            }
        }

        function performLogout(clearAllData = false) {
            try {
                // Clear session management
                clearSessionTimeout();
                
                // Clear current user data
                currentUser = null;
                navigationHistory = [];
                lastActivity = Date.now();
                isSessionWarningShown = false;
                
                if (clearAllData) {
                    // Clear all application data
                    students = [];
                    attendance = [];
                    marks = [];
                    users = [];
                    
                    // Clear all localStorage
                    localStorage.removeItem('studentMS_users');
                    localStorage.removeItem('studentMS_students');
                    localStorage.removeItem('studentMS_attendance');
                    localStorage.removeItem('studentMS_marks');
                    localStorage.removeItem('studentMS_currentUser');
                    localStorage.removeItem('installDismissed');
                    
                    // Reinitialize demo data for next use
                    initializeDemoData();
                    saveData();
                } else {
                    // Only remove current user session
                    localStorage.removeItem('studentMS_currentUser');
                }
                
                // Hide main app and show auth screen
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
                
                // Reset forms and clear errors
                const loginForm = document.getElementById('loginFormElement');
                const registerForm = document.getElementById('registerFormElement');
                
                if (loginForm) {
                    loginForm.reset();
                    clearAllErrors('loginFormElement');
                }
                if (registerForm) {
                    registerForm.reset();
                    clearAllErrors('registerFormElement');
                }
                
                // Show login form (hide register if visible)
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('courseField').style.display = 'none';
                
                // Close any open modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => modal.style.display = 'none');
                
                // Hide back button and export button
                document.getElementById('backButton').style.display = 'none';
                document.getElementById('exportButton').style.display = 'none';
                
                // Reset page title
                document.getElementById('pageTitle').textContent = 'Dashboard';
                document.getElementById('pageSubtitle').textContent = 'Welcome back!';
                
                // Reset install banner if data was cleared
                if (clearAllData) {
                    localStorage.removeItem('installDismissed');
                    showInstallBanner();
                }
                
                if (!clearAllData) {
                    showSuccess('Logged out successfully! 👋 Your data is safely stored.');
                }
                
            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout completed with some issues. Please refresh if needed.');
                
                // Force logout even if there are errors
                currentUser = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('authScreen').style.display = 'flex';
            }
        }

        // Session Management Functions
        function initializeSessionManagement() {
            // Session timeout: 30 minutes of inactivity
            const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
            const WARNING_TIME = 60 * 1000; // Show warning 1 minute before timeout
            
            lastActivity = Date.now();
            
            // Check session every minute
            sessionTimeout = setInterval(() => {
                const now = Date.now();
                const timeSinceActivity = now - lastActivity;
                
                if (timeSinceActivity >= SESSION_TIMEOUT) {
                    // Session expired - force logout
                    clearSessionTimeout();
                    showError('Session expired due to inactivity. Please login again.');
                    performLogout(false);
                } else if (timeSinceActivity >= (SESSION_TIMEOUT - WARNING_TIME) && !isSessionWarningShown) {
                    // Show warning
                    showSessionTimeoutWarning();
                }
            }, 60000); // Check every minute
        }

        function updateLastActivity() {
            lastActivity = Date.now();
            
            // Hide session warning if user becomes active
            if (isSessionWarningShown) {
                closeModal('sessionTimeoutModal');
                isSessionWarningShown = false;
            }
        }

        function showSessionTimeoutWarning() {
            isSessionWarningShown = true;
            openModal('sessionTimeoutModal');
            
            let countdown = 60;
            const countdownElement = document.getElementById('timeoutCountdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                
                if (countdown <= 0 || !isSessionWarningShown) {
                    clearInterval(countdownInterval);
                    
                    if (countdown <= 0 && isSessionWarningShown) {
                        // Time's up - force logout
                        closeModal('sessionTimeoutModal');
                        showError('Session expired due to inactivity. You have been logged out.');
                        performLogout(false);
                    }
                }
            }, 1000);
        }

        function extendSession() {
            lastActivity = Date.now();
            isSessionWarningShown = false;
            closeModal('sessionTimeoutModal');
            showSuccess('Session extended successfully! 🔄');
        }

        function clearSessionTimeout() {
            if (sessionTimeout) {
                clearInterval(sessionTimeout);
                sessionTimeout = null;
            }
        }

        // Main App Functions
        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('headerUserName').textContent = currentUser.name;
            document.getElementById('headerUserRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            setupNavigation();
            navigationHistory = [];
            
            // Initialize session management for logged in users
            initializeSessionManagement();
            
            showDashboard();
        }

        function setupNavigation() {
            const nav = document.getElementById('bottomNav');
            const fab = document.getElementById('fabButton');
            const exportBtn = document.getElementById('exportButton');
            let navItems = [];

            if (currentUser.role === 'admin') {
                navItems = [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', action: 'showDashboard()' },
                    { icon: 'fas fa-users', text: 'Students', action: 'showStudents()' },
                    { icon: 'fas fa-user-check', text: 'Attendance', action: 'showAttendance()' },
                    { icon: 'fas fa-chart-line', text: 'Grades', action: 'showGrades()' },
                    { icon: 'fas fa-sign-out-alt', text: 'Logout', action: 'logout()' }
                ];
                fab.style.display = 'flex';
                exportBtn.style.display = 'flex';
            } else {
                navItems = [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', action: 'showDashboard()' },
                    { icon: 'fas fa-user', text: 'Profile', action: 'showMyProfile()' },
                    { icon: 'fas fa-user-check', text: 'Attendance', action: 'showMyAttendance()' },
                    { icon: 'fas fa-chart-line', text: 'Grades', action: 'showMyGrades()' },
                    { icon: 'fas fa-sign-out-alt', text: 'Logout', action: 'logout()' }
                ];
                fab.style.display = 'none';
                exportBtn.style.display = 'none';
            }

            nav.innerHTML = navItems.map(item => 
                `<div class="nav-item" onclick="${item.action}">
                    <i class="${item.icon}"></i>
                    <span>${item.text}</span>
                </div>`
            ).join('');
        }

        function showDashboard() {
            navigationHistory = [{ page: 'dashboard' }];
            updatePageTitle('Dashboard', 'Welcome back!');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item').classList.add('active');
            
            const contentArea = document.getElementById('contentArea');
            
            if (currentUser.role === 'admin') {
                showAdminDashboard();
            } else {
                showStudentDashboard();
            }
        }

        function showAdminDashboard() {
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'active').length;
            const todayAttendance = attendance.filter(a => a.date === new Date().toISOString().split('T')[0]).length;
            const pendingGrades = marks.filter(m => m.selfReported && !m.verified).length;
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${totalStudents}</div>
                        <div class="text-sm text-gray-600 mt-2">Total Students</div>
                        <div class="text-xs text-green-600 mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>${activeStudents} Active
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${todayAttendance}</div>
                        <div class="text-sm text-gray-600 mt-2">Today's Attendance</div>
                        <div class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>Marked Today
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${marks.length}</div>
                        <div class="text-sm text-gray-600 mt-2">Total Grades</div>
                        <div class="text-xs text-orange-600 mt-1">
                            <i class="fas fa-chart-line mr-1"></i>All Exams
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-orange-600">${pendingGrades}</div>
                        <div class="text-sm text-gray-600 mt-2">Pending Verification</div>
                        <div class="text-xs text-red-600 mt-1">
                            <i class="fas fa-clock mr-1"></i>Needs Review
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📋 Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openModal('addStudentModal')" class="btn-primary text-sm py-3">
                            <i class="fas fa-user-plus mr-2"></i>Add Student
                        </button>
                        <button onclick="showStudents()" class="btn-success text-sm py-3">
                            <i class="fas fa-users mr-2"></i>View Students
                        </button>
                        <button onclick="showAttendance()" class="btn-info text-sm py-3">
                            <i class="fas fa-user-check mr-2"></i>Attendance
                        </button>
                        <button onclick="showGrades()" class="btn-warning text-sm py-3">
                            <i class="fas fa-chart-line mr-2"></i>Grades
                        </button>
                    </div>
                </div>

                <!-- Recent Students -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">👥 Recent Students</h3>
                    <div class="space-y-3 max-h-48 overflow-y-auto">
                        ${students.slice(-5).reverse().map(student => `
                            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl">
                                <div>
                                    <span class="font-semibold text-sm">${student.name}</span>
                                    <span class="text-xs text-gray-600 ml-2">${student.id}</span>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-info text-xs">Semester ${student.semester}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showStudentDashboard() {
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) {
                contentArea.innerHTML = '<div class="card"><p class="text-center text-red-600">Student record not found. Please contact administrator.</p></div>';
                return;
            }

            const studentAttendance = calculateStudentAttendance(studentData.id);
            const studentAverage = calculateStudentAverage(studentData.id);
            const studentCGPA = calculateCGPA(studentData.id);
            const semesterGPA = calculateSemesterGPA(studentData.id, studentData.semester);
            const studentMarks = marks.filter(m => m.studentId === studentData.id);
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- Student Info Card -->
                <div class="card">
                    <div class="flex items-center mb-4">
                        <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-user text-2xl text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">${studentData.name}</h3>
                            <p class="text-gray-600">Student ID: ${studentData.id}</p>
                            <p class="text-sm text-gray-500">Semester ${studentData.semester} • Computer Science Diploma</p>
                        </div>
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${studentAttendance}%</div>
                        <div class="text-sm text-gray-600 mt-2">Attendance Rate</div>
                        <div class="text-xs ${studentAttendance >= 75 ? 'text-green-600' : 'text-red-600'} mt-1">
                            <i class="fas ${studentAttendance >= 75 ? 'fa-check' : 'fa-exclamation-triangle'} mr-1"></i>
                            ${studentAttendance >= 75 ? 'Good' : 'Needs Improvement'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${studentCGPA}</div>
                        <div class="text-sm text-gray-600 mt-2">Overall CGPA</div>
                        <div class="text-xs text-purple-600 mt-1">
                            <i class="fas fa-star mr-1"></i>Out of 10.0
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${semesterGPA}</div>
                        <div class="text-sm text-gray-600 mt-2">Semester ${studentData.semester} GPA</div>
                        <div class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-graduation-cap mr-1"></i>Current Sem
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-orange-600">${studentMarks.filter(m => m.selfReported && !m.verified).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Pending Verification</div>
                        <div class="text-xs text-orange-600 mt-1">
                            <i class="fas fa-clock mr-1"></i>Self-Reported
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📋 Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="showMyProfile()" class="btn-info text-sm py-3">
                            <i class="fas fa-user mr-2"></i>View Profile
                        </button>
                        <button onclick="showMyAttendance()" class="btn-success text-sm py-3">
                            <i class="fas fa-user-check mr-2"></i>My Attendance
                        </button>
                        <button onclick="showMyGrades()" class="btn-primary text-sm py-3">
                            <i class="fas fa-chart-line mr-2"></i>My Grades
                        </button>
                        <button onclick="logout()" class="btn-secondary text-sm py-3">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>

                <!-- Recent Grades -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📈 Recent Grades</h3>
                    <div class="space-y-3 max-h-48 overflow-y-auto">
                        ${studentMarks.slice(-5).reverse().map(mark => `
                            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl">
                                <div>
                                    <span class="font-semibold text-sm">${getSubjectName(mark.subject)}</span>
                                    <span class="text-xs text-gray-600 ml-2">${formatExamType(mark.examType)}</span>
                                    ${mark.selfReported ? '<span class="badge badge-warning ml-2" style="font-size: 8px;">Self</span>' : ''}
                                </div>
                                <div class="text-right">
                                    <span class="font-bold">${mark.obtainedMarks}/${mark.totalMarks}</span>
                                    <span class="text-xs ${getGradeColor(mark.obtainedMarks, mark.totalMarks)} ml-2">
                                        ${calculatePercentage(mark.obtainedMarks, mark.totalMarks)}%
                                    </span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-gray-500 text-center py-6 text-sm">No grades available</p>'}
                    </div>
                </div>
            `;
        }

        // Utility Functions
        function updatePageTitle(title, subtitle) {
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        }

        function getSubjectName(subjectValue) {
            for (let semester in subjects) {
                const subject = subjects[semester].find(s => s.value === subjectValue);
                if (subject) return subject.name;
            }
            return subjectValue;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatExamType(examType) {
            const types = {
                'internal': 'Internal',
                'midterm': 'Mid-term',
                'final': 'Final',
                'practical': 'Practical',
                'assignment': 'Assignment'
            };
            return types[examType] || examType;
        }

        function calculatePercentage(obtained, total) {
            return total > 0 ? Math.round((obtained / total) * 100) : 0;
        }

        function getLetterGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+';
            if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C+';
            if (percentage >= 40) return 'C';
            return 'F';
        }

        function getGradePoints(percentage) {
            if (percentage >= 90) return 10;
            if (percentage >= 80) return 9;
            if (percentage >= 70) return 8;
            if (percentage >= 60) return 7;
            if (percentage >= 50) return 6;
            if (percentage >= 40) return 5;
            return 0;
        }

        function calculateCGPA(studentId) {
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            if (studentGrades.length === 0) return 0;
            
            // Group grades by subject and take the best grade for each subject
            const subjectBestGrades = {};
            studentGrades.forEach(grade => {
                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                if (!subjectBestGrades[grade.subject] || percentage > subjectBestGrades[grade.subject].percentage) {
                    subjectBestGrades[grade.subject] = {
                        percentage: percentage,
                        gradePoints: getGradePoints(percentage)
                    };
                }
            });
            
            const subjects = Object.keys(subjectBestGrades);
            if (subjects.length === 0) return 0;
            
            const totalGradePoints = subjects.reduce((sum, subject) => 
                sum + subjectBestGrades[subject].gradePoints, 0);
            
            return (totalGradePoints / subjects.length).toFixed(2);
        }

        function calculateSemesterGPA(studentId, semester) {
            const semesterSubjects = getSubjectsForSemester(semester);
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            
            if (semesterSubjects.length === 0) return 0;
            
            // Get best grade for each semester subject
            const subjectGrades = {};
            semesterSubjects.forEach(subject => {
                const subjectMarks = studentGrades.filter(g => g.subject === subject.value);
                if (subjectMarks.length > 0) {
                    const bestMark = subjectMarks.reduce((best, current) => {
                        const currentPercentage = calculatePercentage(current.obtainedMarks, current.totalMarks);
                        const bestPercentage = calculatePercentage(best.obtainedMarks, best.totalMarks);
                        return currentPercentage > bestPercentage ? current : best;
                    });
                    const percentage = calculatePercentage(bestMark.obtainedMarks, bestMark.totalMarks);
                    subjectGrades[subject.value] = getGradePoints(percentage);
                }
            });
            
            const completedSubjects = Object.keys(subjectGrades);
            if (completedSubjects.length === 0) return 0;
            
            const totalGradePoints = completedSubjects.reduce((sum, subject) => 
                sum + subjectGrades[subject], 0);
            
            return (totalGradePoints / completedSubjects.length).toFixed(2);
        }

        function updateGradesStats() {
            // Update stats in grades page if visible
            const statsCards = document.querySelectorAll('.stat-card');
            if (statsCards.length >= 4) {
                const verifiedGrades = marks.filter(m => m.verified).length;
                const pendingGrades = marks.filter(m => m.selfReported && !m.verified).length;
                const totalGrades = marks.length;
                const averageScore = totalGrades > 0 ? 
                    Math.round(marks.reduce((sum, m) => sum + calculatePercentage(m.obtainedMarks, m.totalMarks), 0) / totalGrades) : 0;
                
                if (statsCards[0]) statsCards[0].querySelector('.text-3xl').textContent = verifiedGrades;
                if (statsCards[1]) statsCards[1].querySelector('.text-3xl').textContent = pendingGrades;
                if (statsCards[2]) statsCards[2].querySelector('.text-3xl').textContent = totalGrades;
                if (statsCards[3]) statsCards[3].querySelector('.text-3xl').textContent = averageScore + '%';
            }
        }

        function getGradeColor(obtained, total) {
            const percentage = calculatePercentage(obtained, total);
            if (percentage >= 80) return 'text-green-600';
            if (percentage >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }

        function calculateStudentAttendance(studentId) {
            const studentAttendance = attendance.filter(a => a.studentId === studentId);
            if (studentAttendance.length === 0) return 0;
            
            const presentCount = studentAttendance.filter(a => a.status === 'present').length;
            return Math.round((presentCount / studentAttendance.length) * 100);
        }

        function calculateStudentAverage(studentId) {
            const studentMarks = marks.filter(m => m.studentId === studentId && m.verified);
            if (studentMarks.length === 0) return 0;
            
            const totalPercentage = studentMarks.reduce((sum, mark) => 
                sum + calculatePercentage(mark.obtainedMarks, mark.totalMarks), 0);
            return Math.round(totalPercentage / studentMarks.length);
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                
                // Reset forms
                const forms = modal.querySelectorAll('form');
                forms.forEach(form => {
                    form.reset();
                    clearAllErrors(form.id);
                });
            }
        }

        // Student Management Functions
        function addStudent(event) {
            event.preventDefault();
            clearAllErrors('addStudentForm');
            
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim().toLowerCase();
            const course = document.getElementById('studentCourse').value;
            const semester = parseInt(document.getElementById('studentSemester').value);
            const phone = document.getElementById('studentPhone').value.trim();
            
            let hasErrors = false;
            
            // Validation
            if (!name || name.length < 2) {
                showFieldError('studentName', 'Name must be at least 2 characters');
                hasErrors = true;
            }
            
            if (!email || !validateEmail(email)) {
                showFieldError('studentEmail', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            if (students.find(s => s.email.toLowerCase() === email)) {
                showFieldError('studentEmail', 'Email already exists! Please use a different email.');
                hasErrors = true;
            }
            
            if (!course) {
                showFieldError('studentCourse', 'Please select a course');
                hasErrors = true;
            }
            
            if (!semester || semester < 1 || semester > 6) {
                showFieldError('studentSemester', 'Please select a valid semester');
                hasErrors = true;
            }
            
            if (!phone || !validatePhone(phone)) {
                showFieldError('studentPhone', 'Please enter a valid 10-digit phone number');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const addButton = document.getElementById('addStudentButton');
            addButton.disabled = true;
            addButton.innerHTML = '<div class="loading-spinner mr-2"></div>Adding Student...';
            
            setTimeout(() => {
                const studentId = generateStudentId(course);
                
                const newStudent = {
                    id: studentId,
                    name,
                    email,
                    course,
                    semester,
                    phone,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                students.push(newStudent);
                
                // Also create user account
                const newUser = {
                    id: users.length + 1,
                    name,
                    email,
                    password: 'student123', // Default password
                    role: 'student',
                    course,
                    semester,
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                saveData();
                
                showSuccess(`Student added successfully! Student ID: ${studentId}`);
                closeModal('addStudentModal');
                
                // Refresh dashboard
                showDashboard();
                
                addButton.disabled = false;
                addButton.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Student';
            }, 1500);
        }

        // Students Management Functions
        function showStudents() {
            navigationHistory.push({ page: 'students' });
            updatePageTitle('Students', 'Manage all students');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <!-- Search and Filter -->
                <div class="card">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search students by name, ID, or email..." 
                               oninput="filterStudents(this.value)">
                    </div>
                    
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="setStudentFilter('all')">All Students</div>
                        <div class="filter-tab" onclick="setStudentFilter('computer-science')">Computer Science</div>
                        <div class="filter-tab" onclick="setStudentFilter('mechanical')">Mechanical</div>
                        <div class="filter-tab" onclick="setStudentFilter('civil')">Civil</div>
                        <div class="filter-tab" onclick="setStudentFilter('electrical')">Electrical</div>
                    </div>
                </div>

                <!-- Students List -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">📚 Students List</h3>
                        <button onclick="openModal('addStudentModal')" class="btn-primary text-sm px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>Add Student
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Semester</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                ${renderStudentsTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function renderStudentsTable() {
            let filteredStudents = students;
            
            // Apply course filter
            if (currentFilter !== 'all') {
                filteredStudents = students.filter(s => s.course === currentFilter);
            }
            
            // Apply search filter
            if (searchQuery) {
                filteredStudents = filteredStudents.filter(s => 
                    s.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    s.id.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    s.email.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            if (filteredStudents.length === 0) {
                return '<tr><td colspan="7" class="text-center py-8 text-gray-500">No students found</td></tr>';
            }
            
            return filteredStudents.map(student => `
                <tr>
                    <td class="font-semibold text-blue-600">${student.id}</td>
                    <td>
                        <div class="font-semibold">${student.name}</div>
                        <div class="text-xs text-gray-500">${student.email}</div>
                    </td>
                    <td>${getCourseName(student.course)}</td>
                    <td>
                        <span class="badge badge-info">Semester ${student.semester}</span>
                    </td>
                    <td>${student.phone}</td>
                    <td>
                        <span class="badge ${student.status === 'active' ? 'badge-success' : 'badge-danger'}">
                            ${student.status.charAt(0).toUpperCase() + student.status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <div class="flex space-x-2">
                            <button onclick="viewStudent('${student.id}')" class="btn-info text-xs px-2 py-1">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editStudent('${student.id}')" class="btn-warning text-xs px-2 py-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudent('${student.id}')" class="btn-danger text-xs px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getCourseName(courseValue) {
            const courses = {
                'computer-science': 'Computer Science & Engineering',
                'mechanical': 'Mechanical Engineering',
                'civil': 'Civil Engineering',
                'electrical': 'Electrical & Electronics Engineering',
                'electronics-communication': 'Electronics & Communication Engineering',
                'automobile': 'Automobile Engineering',
                'textile': 'Textile Technology',
                'information-science': 'Information Science & Engineering'
            };
            return courses[courseValue] || courseValue;
        }

        function setStudentFilter(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Re-render table
            document.getElementById('studentsTableBody').innerHTML = renderStudentsTable();
        }

        function filterStudents(query) {
            searchQuery = query;
            document.getElementById('studentsTableBody').innerHTML = renderStudentsTable();
        }

        function viewStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            navigationHistory.push({ page: 'viewStudent', studentId });
            updatePageTitle(`Student Details`, `${student.name} (${student.id})`);
            
            const studentAttendance = attendance.filter(a => a.studentId === studentId);
            const studentGrades = marks.filter(m => m.studentId === studentId);
            const attendanceRate = calculateStudentAttendance(studentId);
            const cgpa = calculateCGPA(studentId);
            const semesterGPA = calculateSemesterGPA(studentId, student.semester);
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- Student Profile Header -->
                <div class="card">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mr-6 shadow-lg">
                                <i class="fas fa-user text-3xl text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${student.name}</h2>
                                <p class="text-gray-600">Student ID: ${student.id}</p>
                                <p class="text-sm text-gray-500">${getCourseName(student.course)} • Semester ${student.semester}</p>
                                <p class="text-sm text-blue-600">📧 ${student.email}</p>
                                <p class="text-sm text-green-600">📱 ${student.phone || 'Not provided'}</p>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="editStudent('${student.id}')" class="btn-warning text-sm px-4 py-2">
                                <i class="fas fa-edit mr-2"></i>Edit Student
                            </button>
                            <button onclick="toggleStudentStatus('${student.id}')" class="btn-${student.status === 'active' ? 'secondary' : 'success'} text-sm px-4 py-2">
                                <i class="fas fa-${student.status === 'active' ? 'pause' : 'play'} mr-2"></i>
                                ${student.status === 'active' ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deleteStudent('${student.id}')" class="btn-danger text-sm px-4 py-2">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Performance Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                            <div class="text-2xl font-bold text-blue-600">${attendanceRate}%</div>
                            <div class="text-xs text-gray-600">Attendance Rate</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                            <div class="text-2xl font-bold text-green-600">${cgpa}</div>
                            <div class="text-xs text-gray-600">Overall CGPA</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-xl">
                            <div class="text-2xl font-bold text-purple-600">${semesterGPA}</div>
                            <div class="text-xs text-gray-600">Semester GPA</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl">
                            <div class="text-2xl font-bold text-orange-600">${studentGrades.length}</div>
                            <div class="text-xs text-gray-600">Total Grades</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">⚡ Quick Actions</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="markStudentAttendance('${student.id}')" class="btn-primary text-sm py-3">
                            <i class="fas fa-user-check mr-2"></i>Mark Attendance
                        </button>
                        <button onclick="addStudentGrade('${student.id}')" class="btn-success text-sm py-3">
                            <i class="fas fa-plus mr-2"></i>Add Grade
                        </button>
                        <button onclick="sendNotification('${student.id}')" class="btn-info text-sm py-3">
                            <i class="fas fa-bell mr-2"></i>Send Notification
                        </button>
                        <button onclick="generateStudentReport('${student.id}')" class="btn-warning text-sm py-3">
                            <i class="fas fa-file-alt mr-2"></i>Generate Report
                        </button>
                    </div>
                </div>

                <!-- Recent Attendance -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📅 Recent Attendance</h3>
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Marked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentAttendance.slice(-10).reverse().map(record => `
                                    <tr>
                                        <td>${formatDate(record.date)}</td>
                                        <td>${getSubjectName(record.subject)}</td>
                                        <td>
                                            <span class="badge ${getAttendanceStatusColor(record.status)}">
                                                ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                            </span>
                                        </td>
                                        <td>${record.time || 'N/A'}</td>
                                        <td>
                                            <div class="text-sm">${record.markedBy}</div>
                                            ${record.selfMarked ? '<span class="badge badge-warning text-xs">Self</span>' : ''}
                                        </td>
                                        <td>
                                            <button onclick="editAttendance(${record.id})" class="btn-warning text-xs px-2 py-1 mr-1">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteAttendance(${record.id})" class="btn-danger text-xs px-2 py-1">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="6" class="text-center py-8 text-gray-500">No attendance records</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Grades -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📊 Recent Grades</h3>
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Exam Type</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentGrades.slice(-10).reverse().map(grade => {
                                    const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                                    return `
                                        <tr>
                                            <td>${formatDate(grade.date)}</td>
                                            <td>${getSubjectName(grade.subject)}</td>
                                            <td>${formatExamType(grade.examType)}</td>
                                            <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                                            <td>
                                                <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                                    ${percentage}%
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${getGradeBadgeColor(percentage)}">
                                                    ${getLetterGrade(percentage)}
                                                </span>
                                            </td>
                                            <td>
                                                ${grade.verified ? 
                                                    '<span class="badge badge-success">Verified</span>' : 
                                                    grade.selfReported ? 
                                                        '<span class="badge badge-warning">Pending</span>' : 
                                                        '<span class="badge badge-info">Official</span>'
                                                }
                                            </td>
                                            <td>
                                                <div class="flex space-x-1">
                                                    ${!grade.verified && grade.selfReported ? 
                                                        `<button onclick="verifyGrade(${grade.id})" class="btn-success text-xs px-2 py-1">
                                                            <i class="fas fa-check"></i>
                                                        </button>` : ''
                                                    }
                                                    <button onclick="editGrade(${grade.id})" class="btn-warning text-xs px-2 py-1">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteGrade(${grade.id})" class="btn-danger text-xs px-2 py-1">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') || '<tr><td colspan="8" class="text-center py-8 text-gray-500">No grade records</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            // Populate edit modal with student data
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentEmail').value = student.email;
            document.getElementById('editStudentCourse').value = student.course;
            document.getElementById('editStudentSemester').value = student.semester;
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentStatus').value = student.status;
            document.getElementById('editStudentId').value = student.id;
            
            openModal('editStudentModal');
        }

        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student && confirm(`Are you sure you want to delete ${student.name}?`)) {
                // Remove student from students array
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex > -1) {
                    students.splice(studentIndex, 1);
                }
                
                // Remove user account
                const userIndex = users.findIndex(u => u.email === student.email);
                if (userIndex > -1) {
                    users.splice(userIndex, 1);
                }
                
                // Remove related attendance and marks
                attendance = attendance.filter(a => a.studentId !== studentId);
                marks = marks.filter(m => m.studentId !== studentId);
                
                saveData();
                showSuccess(`${student.name} deleted successfully!`);
                
                // Re-render table
                document.getElementById('studentsTableBody').innerHTML = renderStudentsTable();
            }
        }

        function showAttendance() {
            navigationHistory.push({ page: 'attendance' });
            updatePageTitle('Attendance', 'Manage student attendance');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[2].classList.add('active');
            
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <!-- Attendance Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${attendance.filter(a => a.status === 'present' && a.date === new Date().toISOString().split('T')[0]).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Present Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-red-600">${attendance.filter(a => a.status === 'absent' && a.date === new Date().toISOString().split('T')[0]).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Absent Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${attendance.length}</div>
                        <div class="text-sm text-gray-600 mt-2">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${Math.round((attendance.filter(a => a.status === 'present').length / attendance.length) * 100) || 0}%</div>
                        <div class="text-sm text-gray-600 mt-2">Overall Rate</div>
                    </div>
                </div>

                <!-- Mark Attendance -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📝 Mark Attendance</h3>
                    <form onsubmit="markAttendance(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Student *</label>
                                <select id="attendanceStudent" required class="input-field">
                                    <option value="">Select Student</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                                <select id="attendanceSubject" required class="input-field">
                                    <option value="">Select Subject</option>
                                    ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                                <input type="date" id="attendanceDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                                <select id="attendanceStatus" required class="input-field">
                                    <option value="">Select Status</option>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="late">Late</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>Mark Attendance
                        </button>
                    </form>
                </div>

                <!-- Attendance Records -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">📊 Attendance Records</h3>
                        <div class="flex space-x-2">
                            <input type="date" id="filterDate" class="input-field text-sm" onchange="filterAttendanceByDate(this.value)" 
                                   value="${new Date().toISOString().split('T')[0]}">
                            <button onclick="clearDateFilter()" class="btn-secondary text-sm px-3 py-2">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Marked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                ${renderAttendanceTable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function renderAttendanceTable() {
            let filteredAttendance = [...attendance].reverse(); // Show latest first
            
            if (filteredAttendance.length === 0) {
                return '<tr><td colspan="6" class="text-center py-8 text-gray-500">No attendance records found</td></tr>';
            }
            
            return filteredAttendance.map(record => {
                const student = students.find(s => s.id === record.studentId);
                return `
                    <tr>
                        <td>${formatDate(record.date)}</td>
                        <td>
                            <div class="font-semibold">${student ? student.name : 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${record.studentId}</div>
                        </td>
                        <td>${getSubjectName(record.subject)}</td>
                        <td>
                            <span class="badge ${getAttendanceStatusColor(record.status)}">
                                ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                            </span>
                        </td>
                        <td>
                            <div class="text-sm">${record.markedBy}</div>
                            ${record.selfMarked ? '<span class="badge badge-warning text-xs">Self</span>' : ''}
                        </td>
                        <td>
                            <button onclick="deleteAttendance(${record.id})" class="btn-danger text-xs px-2 py-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAttendanceStatusColor(status) {
            switch(status) {
                case 'present': return 'badge-success';
                case 'absent': return 'badge-danger';
                case 'late': return 'badge-warning';
                default: return 'badge-secondary';
            }
        }

        function markAttendance(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('attendanceStudent').value;
            const subject = document.getElementById('attendanceSubject').value;
            const date = document.getElementById('attendanceDate').value;
            const status = document.getElementById('attendanceStatus').value;
            
            if (!studentId || !subject || !date || !status) {
                showError('Please fill all required fields');
                return;
            }
            
            // Check if it's Sunday
            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            if (dayOfWeek === 0) {
                const confirmSunday = confirm('📅 This is a Sunday! Are you sure you want to mark attendance? Classes are usually not held on Sundays.');
                if (!confirmSunday) {
                    return;
                }
            }
            
            // Check if attendance already exists for this student, subject, and date
            const existingRecord = attendance.find(a => 
                a.studentId === studentId && 
                a.subject === subject && 
                a.date === date
            );
            
            if (existingRecord) {
                showError('Attendance already marked for this student, subject, and date');
                return;
            }
            
            const newAttendance = {
                id: attendance.length + 1,
                studentId,
                subject,
                date,
                status,
                markedBy: currentUser.email,
                selfMarked: false,
                createdAt: new Date().toISOString()
            };
            
            attendance.push(newAttendance);
            saveData();
            
            showSuccess('Attendance marked successfully!');
            
            // Reset form
            event.target.reset();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            // Re-render table
            document.getElementById('attendanceTableBody').innerHTML = renderAttendanceTable();
        }

        function filterAttendanceByDate(date) {
            const tbody = document.getElementById('attendanceTableBody');
            if (date) {
                const filtered = attendance.filter(a => a.date === date).reverse();
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No records found for this date</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(record => {
                        const student = students.find(s => s.id === record.studentId);
                        return `
                            <tr>
                                <td>${formatDate(record.date)}</td>
                                <td>
                                    <div class="font-semibold">${student ? student.name : 'Unknown'}</div>
                                    <div class="text-xs text-gray-500">${record.studentId}</div>
                                </td>
                                <td>${getSubjectName(record.subject)}</td>
                                <td>
                                    <span class="badge ${getAttendanceStatusColor(record.status)}">
                                        ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                    </span>
                                </td>
                                <td>
                                    <div class="text-sm">${record.markedBy}</div>
                                    ${record.selfMarked ? '<span class="badge badge-warning text-xs">Self</span>' : ''}
                                </td>
                                <td>
                                    <button onclick="deleteAttendance(${record.id})" class="btn-danger text-xs px-2 py-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } else {
                tbody.innerHTML = renderAttendanceTable();
            }
        }

        function clearDateFilter() {
            document.getElementById('filterDate').value = '';
            document.getElementById('attendanceTableBody').innerHTML = renderAttendanceTable();
        }

        function deleteAttendance(attendanceId) {
            if (confirm('Are you sure you want to delete this attendance record?')) {
                const index = attendance.findIndex(a => a.id === attendanceId);
                if (index > -1) {
                    attendance.splice(index, 1);
                    saveData();
                    showSuccess('Attendance record deleted successfully!');
                    document.getElementById('attendanceTableBody').innerHTML = renderAttendanceTable();
                }
            }
        }

        function showGrades() {
            navigationHistory.push({ page: 'grades' });
            updatePageTitle('Grades', 'Manage student grades');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[3].classList.add('active');
            
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <!-- Grades Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${marks.filter(m => m.verified).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Verified Grades</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-orange-600">${marks.filter(m => m.selfReported && !m.verified).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Pending Verification</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${marks.length}</div>
                        <div class="text-sm text-gray-600 mt-2">Total Grades</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${Math.round(marks.reduce((sum, m) => sum + calculatePercentage(m.obtainedMarks, m.totalMarks), 0) / marks.length) || 0}%</div>
                        <div class="text-sm text-gray-600 mt-2">Average Score</div>
                    </div>
                </div>

                <!-- Add Grade -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📝 Add Grade</h3>
                    <form onsubmit="addGrade(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Student *</label>
                                <select id="gradeStudent" required class="input-field">
                                    <option value="">Select Student</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                                <select id="gradeSubject" required class="input-field">
                                    <option value="">Select Subject</option>
                                    ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Exam Type *</label>
                                <select id="gradeExamType" required class="input-field">
                                    <option value="">Select Exam Type</option>
                                    <option value="internal">Internal Assessment</option>
                                    <option value="midterm">Mid-term Exam</option>
                                    <option value="final">Final Exam</option>
                                    <option value="practical">Practical Exam</option>
                                    <option value="assignment">Assignment</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                                <input type="date" id="gradeDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Total Marks *</label>
                                <input type="number" id="gradeTotalMarks" required class="input-field" min="1" max="1000" placeholder="e.g., 100">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Obtained Marks *</label>
                                <input type="number" id="gradeObtainedMarks" required class="input-field" min="0" placeholder="e.g., 85">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" id="addGradeButton">
                            <i class="fas fa-plus mr-2"></i>Add Grade
                        </button>
                    </form>
                </div>

                <!-- Grades Records -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">📊 Grades Records</h3>
                        <div class="flex space-x-2">
                            <select id="filterStudent" class="input-field text-sm" onchange="filterGradesByStudent(this.value)">
                                <option value="">All Students</option>
                                ${students.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                            <select id="filterSubject" class="input-field text-sm" onchange="filterGradesBySubject(this.value)">
                                <option value="">All Subjects</option>
                                ${Object.values(subjects).flat().map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                            </select>
                            <button onclick="clearGradeFilters()" class="btn-secondary text-sm px-3 py-2">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Subject</th>
                                    <th>Exam Type</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Grade Points</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gradesTableBody">
                                ${renderGradesTable()}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- CGPA Summary -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">🎓 CGPA Summary by Student</h3>
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Semester</th>
                                    <th>Current Sem GPA</th>
                                    <th>Overall CGPA</th>
                                    <th>Total Subjects</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderCGPATable()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function renderGradesTable() {
            let filteredGrades = [...marks].reverse(); // Show latest first
            
            if (filteredGrades.length === 0) {
                return '<tr><td colspan="10" class="text-center py-8 text-gray-500">No grade records found</td></tr>';
            }
            
            return filteredGrades.map(grade => {
                const student = students.find(s => s.id === grade.studentId);
                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                const gradePoints = getGradePoints(percentage);
                return `
                    <tr>
                        <td>${formatDate(grade.date)}</td>
                        <td>
                            <div class="font-semibold">${student ? student.name : 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${grade.studentId}</div>
                        </td>
                        <td>${getSubjectName(grade.subject)}</td>
                        <td>${formatExamType(grade.examType)}</td>
                        <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                        <td>
                            <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                ${percentage}%
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getGradeBadgeColor(percentage)}">
                                ${getLetterGrade(percentage)}
                            </span>
                        </td>
                        <td>
                            <span class="font-bold text-purple-600">${gradePoints}/10</span>
                        </td>
                        <td>
                            ${grade.verified ? 
                                '<span class="badge badge-success">Verified</span>' : 
                                grade.selfReported ? 
                                    '<span class="badge badge-warning">Pending</span>' : 
                                    '<span class="badge badge-info">Official</span>'
                            }
                        </td>
                        <td>
                            <div class="flex space-x-1">
                                ${!grade.verified && grade.selfReported ? 
                                    `<button onclick="verifyGrade(${grade.id})" class="btn-success text-xs px-2 py-1">
                                        <i class="fas fa-check"></i>
                                    </button>` : ''
                                }
                                <button onclick="deleteGrade(${grade.id})" class="btn-danger text-xs px-2 py-1">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderCGPATable() {
            if (students.length === 0) {
                return '<tr><td colspan="7" class="text-center py-8 text-gray-500">No students found</td></tr>';
            }
            
            return students.map(student => {
                const cgpa = calculateCGPA(student.id);
                const semesterGPA = calculateSemesterGPA(student.id, student.semester);
                const studentGrades = marks.filter(m => m.studentId === student.id && m.verified);
                const uniqueSubjects = [...new Set(studentGrades.map(g => g.subject))].length;
                
                let performanceLevel = 'Excellent';
                let performanceColor = 'text-green-600';
                
                if (cgpa < 5) {
                    performanceLevel = 'Needs Improvement';
                    performanceColor = 'text-red-600';
                } else if (cgpa < 7) {
                    performanceLevel = 'Good';
                    performanceColor = 'text-yellow-600';
                } else if (cgpa < 8.5) {
                    performanceLevel = 'Very Good';
                    performanceColor = 'text-blue-600';
                }
                
                return `
                    <tr>
                        <td class="font-semibold text-blue-600">${student.id}</td>
                        <td>
                            <div class="font-semibold">${student.name}</div>
                            <div class="text-xs text-gray-500">${getCourseName(student.course)}</div>
                        </td>
                        <td>
                            <span class="badge badge-info">Semester ${student.semester}</span>
                        </td>
                        <td>
                            <span class="font-bold text-purple-600">${semesterGPA}/10</span>
                        </td>
                        <td>
                            <span class="font-bold text-green-600">${cgpa}/10</span>
                        </td>
                        <td class="text-center">${uniqueSubjects}</td>
                        <td>
                            <span class="font-semibold ${performanceColor}">${performanceLevel}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getGradeBadgeColor(percentage) {
            if (percentage >= 90) return 'badge-success';
            if (percentage >= 80) return 'badge-info';
            if (percentage >= 70) return 'badge-warning';
            if (percentage >= 60) return 'badge-secondary';
            return 'badge-danger';
        }

        function addGrade(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('gradeStudent').value;
            const subject = document.getElementById('gradeSubject').value;
            const examType = document.getElementById('gradeExamType').value;
            const date = document.getElementById('gradeDate').value;
            const totalMarks = parseInt(document.getElementById('gradeTotalMarks').value);
            const obtainedMarks = parseInt(document.getElementById('gradeObtainedMarks').value);
            
            // Comprehensive validation
            if (!studentId || !subject || !examType || !date || !totalMarks || obtainedMarks === undefined) {
                showError('Please fill all required fields');
                return;
            }
            
            if (obtainedMarks > totalMarks) {
                showError('Obtained marks cannot be greater than total marks');
                return;
            }
            
            if (obtainedMarks < 0) {
                showError('Obtained marks cannot be negative');
                return;
            }
            
            if (totalMarks <= 0 || totalMarks > 1000) {
                showError('Total marks must be between 1 and 1000');
                return;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const selectedDate = new Date(date);
            
            if (selectedDate > today) {
                showError('Cannot add grades for future dates');
                return;
            }
            
            // Check for duplicate entries
            const existingGrade = marks.find(m => 
                m.studentId === studentId && 
                m.subject === subject && 
                m.examType === examType && 
                m.date === date
            );
            
            if (existingGrade) {
                showError('Grade already exists for this student, subject, exam type, and date');
                return;
            }
            
            // Validate student exists
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Selected student not found');
                return;
            }
            
            // Validate subject belongs to student's semester
            const studentSemesterSubjects = getSubjectsForSemester(student.semester);
            const validSubject = studentSemesterSubjects.find(s => s.value === subject);
            if (!validSubject) {
                showError(`Subject "${getSubjectName(subject)}" is not valid for ${student.name}'s semester (${student.semester})`);
                return;
            }
            
            const addButton = document.getElementById('addGradeButton');
            if (addButton) {
                addButton.disabled = true;
                addButton.innerHTML = '<div class="loading-spinner mr-2"></div>Adding Grade...';
            }
            
            setTimeout(() => {
                const newGrade = {
                    id: marks.length + 1,
                    studentId,
                    subject,
                    examType,
                    date,
                    totalMarks,
                    obtainedMarks,
                    addedBy: currentUser.email,
                    selfReported: false,
                    verified: true,
                    createdAt: new Date().toISOString()
                };
                
                marks.push(newGrade);
                saveData();
                
                const percentage = calculatePercentage(obtainedMarks, totalMarks);
                const grade = getLetterGrade(percentage);
                showSuccess(`Grade added successfully! ${student.name}: ${obtainedMarks}/${totalMarks} (${percentage}% - Grade ${grade})`);
                
                // Reset form
                event.target.reset();
                document.getElementById('gradeDate').value = new Date().toISOString().split('T')[0];
                
                // Re-render table and update stats
                document.getElementById('gradesTableBody').innerHTML = renderGradesTable();
                updateGradesStats();
                
                if (addButton) {
                    addButton.disabled = false;
                    addButton.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Grade';
                }
            }, 1000);
        }

        function filterGradesByStudent(studentId) {
            const tbody = document.getElementById('gradesTableBody');
            if (studentId) {
                const filtered = marks.filter(m => m.studentId === studentId).reverse();
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">No grades found for this student</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(grade => {
                        const student = students.find(s => s.id === grade.studentId);
                        const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                        return `
                            <tr>
                                <td>${formatDate(grade.date)}</td>
                                <td>
                                    <div class="font-semibold">${student ? student.name : 'Unknown'}</div>
                                    <div class="text-xs text-gray-500">${grade.studentId}</div>
                                </td>
                                <td>${getSubjectName(grade.subject)}</td>
                                <td>${formatExamType(grade.examType)}</td>
                                <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                                <td>
                                    <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                        ${percentage}%
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${getGradeBadgeColor(percentage)}">
                                        ${getLetterGrade(percentage)}
                                    </span>
                                </td>
                                <td>
                                    ${grade.verified ? 
                                        '<span class="badge badge-success">Verified</span>' : 
                                        grade.selfReported ? 
                                            '<span class="badge badge-warning">Pending</span>' : 
                                            '<span class="badge badge-info">Official</span>'
                                    }
                                </td>
                                <td>
                                    <div class="flex space-x-1">
                                        ${!grade.verified && grade.selfReported ? 
                                            `<button onclick="verifyGrade(${grade.id})" class="btn-success text-xs px-2 py-1">
                                                <i class="fas fa-check"></i>
                                            </button>` : ''
                                        }
                                        <button onclick="deleteGrade(${grade.id})" class="btn-danger text-xs px-2 py-1">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } else {
                tbody.innerHTML = renderGradesTable();
            }
        }

        function filterGradesBySubject(subject) {
            const tbody = document.getElementById('gradesTableBody');
            if (subject) {
                const filtered = marks.filter(m => m.subject === subject).reverse();
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">No grades found for this subject</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(grade => {
                        const student = students.find(s => s.id === grade.studentId);
                        const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                        const gradePoints = getGradePoints(percentage);
                        return `
                            <tr>
                                <td>${formatDate(grade.date)}</td>
                                <td>
                                    <div class="font-semibold">${student ? student.name : 'Unknown'}</div>
                                    <div class="text-xs text-gray-500">${grade.studentId}</div>
                                </td>
                                <td>${getSubjectName(grade.subject)}</td>
                                <td>${formatExamType(grade.examType)}</td>
                                <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                                <td>
                                    <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                        ${percentage}%
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${getGradeBadgeColor(percentage)}">
                                        ${getLetterGrade(percentage)}
                                    </span>
                                </td>
                                <td>
                                    <span class="font-bold text-purple-600">${gradePoints}/10</span>
                                </td>
                                <td>
                                    ${grade.verified ? 
                                        '<span class="badge badge-success">Verified</span>' : 
                                        grade.selfReported ? 
                                            '<span class="badge badge-warning">Pending</span>' : 
                                            '<span class="badge badge-info">Official</span>'
                                    }
                                </td>
                                <td>
                                    <div class="flex space-x-1">
                                        ${!grade.verified && grade.selfReported ? 
                                            `<button onclick="verifyGrade(${grade.id})" class="btn-success text-xs px-2 py-1">
                                                <i class="fas fa-check"></i>
                                            </button>` : ''
                                        }
                                        <button onclick="deleteGrade(${grade.id})" class="btn-danger text-xs px-2 py-1">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } else {
                tbody.innerHTML = renderGradesTable();
            }
        }

        function clearGradeFilters() {
            document.getElementById('filterStudent').value = '';
            document.getElementById('filterSubject').value = '';
            document.getElementById('gradesTableBody').innerHTML = renderGradesTable();
        }

        function verifyGrade(gradeId) {
            const grade = marks.find(m => m.id === gradeId);
            if (grade && confirm(`Verify grade: ${grade.obtainedMarks}/${grade.totalMarks} for ${getSubjectName(grade.subject)}?`)) {
                grade.verified = true;
                saveData();
                showSuccess('Grade verified successfully!');
                document.getElementById('gradesTableBody').innerHTML = renderGradesTable();
            }
        }

        function deleteGrade(gradeId) {
            if (confirm('Are you sure you want to delete this grade record?')) {
                const index = marks.findIndex(m => m.id === gradeId);
                if (index > -1) {
                    marks.splice(index, 1);
                    saveData();
                    showSuccess('Grade record deleted successfully!');
                    document.getElementById('gradesTableBody').innerHTML = renderGradesTable();
                }
            }
        }

        function showMyProfile() {
            navigationHistory.push({ page: 'myProfile' });
            updatePageTitle('My Profile', 'View and edit your profile');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            
            const userData = users.find(u => u.email === currentUser.email);
            const studentData = currentUser.role === 'student' ? students.find(s => s.email === currentUser.email) : null;
            
            if (!userData) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p class="text-center text-red-600">User data not found. Please contact administrator.</p></div>';
                return;
            }
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- Profile Header -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-content mr-6 shadow-lg">
                            <i class="fas fa-user text-3xl text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">${userData.name}</h2>
                            <p class="text-gray-600">${userData.email}</p>
                            <p class="text-sm text-gray-500 capitalize">
                                ${userData.role}${studentData ? ` • ${getCourseName(studentData.course)} • Semester ${studentData.semester}` : ''}
                            </p>
                            ${studentData ? `<p class="text-sm text-blue-600 font-semibold">Student ID: ${studentData.id}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                            <div class="text-2xl font-bold text-blue-600">${formatDate(userData.createdAt).split(',')[0]}</div>
                            <div class="text-xs text-gray-600">Member Since</div>
                        </div>
                        ${currentUser.role === 'student' ? `
                            <div class="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                                <div class="text-2xl font-bold text-green-600">${calculateCGPA(studentData.id)}</div>
                                <div class="text-xs text-gray-600">CGPA</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-xl">
                                <div class="text-2xl font-bold text-purple-600">${calculateStudentAttendance(studentData.id)}%</div>
                                <div class="text-xs text-gray-600">Attendance</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl">
                                <div class="text-2xl font-bold text-orange-600">${marks.filter(m => m.studentId === studentData.id).length}</div>
                                <div class="text-xs text-gray-600">Total Grades</div>
                            </div>
                        ` : `
                            <div class="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl">
                                <div class="text-2xl font-bold text-green-600">${students.length}</div>
                                <div class="text-xs text-gray-600">Students</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-xl">
                                <div class="text-2xl font-bold text-purple-600">${attendance.length}</div>
                                <div class="text-xs text-gray-600">Attendance Records</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-xl">
                                <div class="text-2xl font-bold text-orange-600">${marks.length}</div>
                                <div class="text-xs text-gray-600">Grade Records</div>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Edit Profile -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">✏️ Edit Profile</h3>
                    <form onsubmit="updateProfile(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                                <input type="text" id="profileName" required class="input-field" value="${userData.name}" minlength="2">
                                <div class="error-text" id="profileNameError">Name must be at least 2 characters</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                                <input type="email" id="profileEmail" required class="input-field" value="${userData.email}">
                                <div class="error-text" id="profileEmailError">Please enter a valid email address</div>
                            </div>
                            ${currentUser.role === 'student' && studentData ? `
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" id="profilePhone" class="input-field" value="${studentData.phone || ''}" pattern="[0-9]{10}">
                                    <div class="error-text" id="profilePhoneError">Please enter a valid 10-digit phone number</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Course</label>
                                    <select id="profileCourse" class="input-field" disabled>
                                        <option value="${studentData.course}">${getCourseName(studentData.course)}</option>
                                    </select>
                                    <div class="text-xs text-gray-500 mt-1">Contact admin to change course</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current Semester</label>
                                    <select id="profileSemester" class="input-field">
                                        <option value="1" ${studentData.semester === 1 ? 'selected' : ''}>1st Semester</option>
                                        <option value="2" ${studentData.semester === 2 ? 'selected' : ''}>2nd Semester</option>
                                        <option value="3" ${studentData.semester === 3 ? 'selected' : ''}>3rd Semester</option>
                                        <option value="4" ${studentData.semester === 4 ? 'selected' : ''}>4th Semester</option>
                                        <option value="5" ${studentData.semester === 5 ? 'selected' : ''}>5th Semester</option>
                                        <option value="6" ${studentData.semester === 6 ? 'selected' : ''}>6th Semester</option>
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                        <button type="submit" class="btn-primary" id="updateProfileButton">
                            <i class="fas fa-save mr-2"></i>Update Profile
                        </button>
                    </form>
                </div>

                <!-- Change Password -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">🔒 Change Password</h3>
                    <form onsubmit="changePassword(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Current Password *</label>
                                <input type="password" id="currentPassword" required class="input-field" placeholder="Enter current password" minlength="6">
                                <div class="error-text" id="currentPasswordError">Please enter your current password</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">New Password *</label>
                                <input type="password" id="newPassword" required class="input-field" placeholder="Enter new password" minlength="6">
                                <div class="error-text" id="newPasswordError">Password must be at least 6 characters</div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm New Password *</label>
                                <input type="password" id="confirmPassword" required class="input-field" placeholder="Confirm new password" minlength="6">
                                <div class="error-text" id="confirmPasswordError">Passwords do not match</div>
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Password Requirements:</strong>
                                    <ul class="mt-1 ml-4 list-disc text-xs">
                                        <li>At least 6 characters long</li>
                                        <li>Must contain both letters and numbers</li>
                                        <li>Avoid using personal information</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-warning" id="changePasswordButton">
                            <i class="fas fa-key mr-2"></i>Change Password
                        </button>
                    </form>
                </div>

                <!-- Account Information -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">ℹ️ Account Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Account Details</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                    <span class="text-sm font-medium text-gray-600">Account Type</span>
                                    <span class="badge ${userData.role === 'admin' ? 'badge-danger' : 'badge-info'} capitalize">${userData.role}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                    <span class="text-sm font-medium text-gray-600">Member Since</span>
                                    <span class="text-sm font-semibold text-gray-800">${formatDate(userData.createdAt)}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                    <span class="text-sm font-medium text-gray-600">Account Status</span>
                                    <span class="badge badge-success">Active</span>
                                </div>
                                ${studentData ? `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                        <span class="text-sm font-medium text-gray-600">Student ID</span>
                                        <span class="text-sm font-semibold text-blue-600">${studentData.id}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Quick Actions</h4>
                            <div class="space-y-2">
                                ${currentUser.role === 'student' ? `
                                    <button onclick="showMyGrades()" class="w-full btn-info text-sm py-3">
                                        <i class="fas fa-chart-line mr-2"></i>View My Grades
                                    </button>
                                    <button onclick="showMyAttendance()" class="w-full btn-success text-sm py-3">
                                        <i class="fas fa-user-check mr-2"></i>View My Attendance
                                    </button>
                                ` : `
                                    <button onclick="showStudents()" class="w-full btn-info text-sm py-3">
                                        <i class="fas fa-users mr-2"></i>Manage Students
                                    </button>
                                    <button onclick="showGrades()" class="w-full btn-success text-sm py-3">
                                        <i class="fas fa-chart-line mr-2"></i>Manage Grades
                                    </button>
                                `}
                                <button onclick="exportProfileData()" class="w-full btn-secondary text-sm py-3">
                                    <i class="fas fa-download mr-2"></i>Export My Data
                                </button>
                                <button onclick="logout()" class="w-full btn-danger text-sm py-3">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                ${currentUser.role === 'student' && studentData ? `
                    <!-- Academic Progress -->
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">📈 Academic Progress</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Grade Distribution</h4>
                                <div class="space-y-2">
                                    ${generateGradeDistribution(studentData.id)}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Attendance by Subject</h4>
                                <div class="space-y-2">
                                    ${generateAttendanceBySubject(studentData.id, studentData.semester)}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function showMyAttendance() {
            navigationHistory.push({ page: 'myAttendance' });
            updatePageTitle('My Attendance', 'View and mark your attendance');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[2].classList.add('active');
            
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p class="text-center text-red-600">Student record not found. Please contact administrator.</p></div>';
                return;
            }

            const myAttendance = attendance.filter(a => a.studentId === studentData.id);
            const attendanceRate = calculateStudentAttendance(studentData.id);
            const todayAttendance = myAttendance.filter(a => a.date === new Date().toISOString().split('T')[0]);
            const thisWeekAttendance = myAttendance.filter(a => {
                const recordDate = new Date(a.date);
                const today = new Date();
                const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                return recordDate >= weekStart;
            });
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- Attendance Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold ${attendanceRate >= 75 ? 'text-green-600' : 'text-red-600'}">${attendanceRate}%</div>
                        <div class="text-sm text-gray-600 mt-2">Overall Attendance</div>
                        <div class="text-xs ${attendanceRate >= 75 ? 'text-green-600' : 'text-red-600'} mt-1">
                            <i class="fas ${attendanceRate >= 75 ? 'fa-check' : 'fa-exclamation-triangle'} mr-1"></i>
                            ${attendanceRate >= 75 ? 'Good Standing' : 'Below Required'}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${todayAttendance.length}</div>
                        <div class="text-sm text-gray-600 mt-2">Today's Classes</div>
                        <div class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-calendar-day mr-1"></i>Marked Today
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${thisWeekAttendance.length}</div>
                        <div class="text-sm text-gray-600 mt-2">This Week</div>
                        <div class="text-xs text-purple-600 mt-1">
                            <i class="fas fa-calendar-week mr-1"></i>Total Classes
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${myAttendance.filter(a => a.status === 'present').length}</div>
                        <div class="text-sm text-gray-600 mt-2">Total Present</div>
                        <div class="text-xs text-green-600 mt-1">
                            <i class="fas fa-user-check mr-1"></i>All Time
                        </div>
                    </div>
                </div>

                <!-- Mark Self Attendance -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">✅ Mark My Attendance</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <span class="text-sm text-blue-800">You can mark your own attendance. Admin verification may be required.</span>
                        </div>
                    </div>
                    <form onsubmit="markSelfAttendance(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                                <select id="selfAttendanceSubject" required class="input-field">
                                    <option value="">Select Subject</option>
                                    ${getSubjectsForSemester(studentData.semester).map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                                <input type="date" id="selfAttendanceDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}" max="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Status *</label>
                                <select id="selfAttendanceStatus" required class="input-field">
                                    <option value="">Select Status</option>
                                    <option value="present">Present</option>
                                    <option value="absent">Absent</option>
                                    <option value="late">Late</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                                <input type="time" id="selfAttendanceTime" class="input-field" value="${new Date().toTimeString().slice(0,5)}">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>Mark Attendance
                        </button>
                    </form>
                </div>

                <!-- My Attendance Records -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">📊 My Attendance History</h3>
                        <div class="flex space-x-2">
                            <select id="filterMySubject" class="input-field text-sm" onchange="filterMyAttendanceBySubject(this.value)">
                                <option value="">All Subjects</option>
                                ${getSubjectsForSemester(studentData.semester).map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                            </select>
                            <input type="month" id="filterMyMonth" class="input-field text-sm" onchange="filterMyAttendanceByMonth(this.value)" 
                                   value="${new Date().toISOString().slice(0,7)}">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Marked By</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="myAttendanceTableBody">
                                ${renderMyAttendanceTable(studentData.id)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Summary by Subject -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📈 Subject-wise Attendance</h3>
                    <div class="space-y-3">
                        ${generateSubjectAttendanceSummary(studentData.id, studentData.semester)}
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function showMyGrades() {
            navigationHistory.push({ page: 'myGrades' });
            updatePageTitle('My Grades', 'View grades and AI predictions');
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[3].classList.add('active');
            
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) {
                document.getElementById('contentArea').innerHTML = '<div class="card"><p class="text-center text-red-600">Student record not found. Please contact administrator.</p></div>';
                return;
            }

            const myGrades = marks.filter(m => m.studentId === studentData.id);
            const studentAverage = calculateStudentAverage(studentData.id);
            const studentCGPA = calculateCGPA(studentData.id);
            const semesterGPA = calculateSemesterGPA(studentData.id, studentData.semester);
            const aiPrediction = generateAIPrediction(studentData.id);
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <!-- AI Performance Prediction -->
                <div class="prediction-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-xl text-white">🤖 AI Performance Analysis</h3>
                        <span class="ai-badge">AI POWERED</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-3xl font-bold text-white mb-2">${aiPrediction.predictedGrade}</div>
                            <div class="text-white/80 text-sm">Predicted Final Grade</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-white mb-2">${aiPrediction.riskLevel}</div>
                            <div class="text-white/80 text-sm">Performance Risk</div>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4">
                        <h4 class="font-semibold text-white mb-2">📊 AI Insights:</h4>
                        <ul class="text-white/90 text-sm space-y-1">
                            ${aiPrediction.insights.map(insight => `<li>• ${insight}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-4 text-center">
                        <button onclick="generateDetailedAnalysis('${studentData.id}')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">
                            <i class="fas fa-chart-line mr-2"></i>Get Detailed Analysis
                        </button>
                    </div>
                </div>

                <!-- Grades Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-green-600">${studentCGPA}</div>
                        <div class="text-sm text-gray-600 mt-2">Overall CGPA</div>
                        <div class="text-xs text-purple-600 mt-1">
                            <i class="fas fa-star mr-1"></i>Out of 10.0
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-purple-600">${semesterGPA}</div>
                        <div class="text-sm text-gray-600 mt-2">Semester ${studentData.semester} GPA</div>
                        <div class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-graduation-cap mr-1"></i>Current Sem
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-blue-600">${myGrades.filter(m => m.verified).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Verified Grades</div>
                        <div class="text-xs text-green-600 mt-1">
                            <i class="fas fa-check-circle mr-1"></i>Official
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="text-3xl font-bold text-orange-600">${myGrades.filter(m => m.selfReported && !m.verified).length}</div>
                        <div class="text-sm text-gray-600 mt-2">Pending Verification</div>
                        <div class="text-xs text-orange-600 mt-1">
                            <i class="fas fa-clock mr-1"></i>Self-Reported
                        </div>
                    </div>
                </div>

                <!-- Add Self Grade -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📝 Report My Grade</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                            <span class="text-sm text-yellow-800">Self-reported grades require admin verification before being official.</span>
                        </div>
                    </div>
                    <form onsubmit="addSelfGrade(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subject *</label>
                                <select id="selfGradeSubject" required class="input-field">
                                    <option value="">Select Subject</option>
                                    ${getSubjectsForSemester(studentData.semester).map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Exam Type *</label>
                                <select id="selfGradeExamType" required class="input-field">
                                    <option value="">Select Exam Type</option>
                                    <option value="internal">Internal Assessment</option>
                                    <option value="midterm">Mid-term Exam</option>
                                    <option value="final">Final Exam</option>
                                    <option value="practical">Practical Exam</option>
                                    <option value="assignment">Assignment</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date *</label>
                                <input type="date" id="selfGradesDate" required class="input-field" value="${new Date().toISOString().split('T')[0]}" max="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Total Marks *</label>
                                <input type="number" id="selfGradeTotalMarks" required class="input-field" min="1" max="1000" placeholder="e.g., 100">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Obtained Marks *</label>
                                <input type="number" id="selfGradeObtainedMarks" required class="input-field" min="0" placeholder="e.g., 85">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Report Grade
                        </button>
                    </form>
                </div>

                <!-- Current Semester Grades -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📚 Semester ${studentData.semester} Grades</h3>
                    <div class="space-y-3">
                        ${generateSemesterGradesSummary(studentData.id, studentData.semester)}
                    </div>
                </div>

                <!-- My Grades History -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">📊 My Grades History</h3>
                        <div class="flex space-x-2">
                            <select id="filterMyGradeSubject" class="input-field text-sm" onchange="filterMyGradesBySubject(this.value)">
                                <option value="">All Subjects</option>
                                ${getSubjectsForSemester(studentData.semester).map(s => `<option value="${s.value}">${s.name}</option>`).join('')}
                            </select>
                            <select id="filterMyGradeType" class="input-field text-sm" onchange="filterMyGradesByType(this.value)">
                                <option value="">All Types</option>
                                <option value="internal">Internal</option>
                                <option value="midterm">Mid-term</option>
                                <option value="final">Final</option>
                                <option value="practical">Practical</option>
                                <option value="assignment">Assignment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Exam Type</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Grade Points</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="myGradesTableBody">
                                ${renderMyGradesTable(studentData.id)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Performance Analytics -->
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">📈 Performance Analytics <span class="ai-badge">AI</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-3">Subject Performance</h4>
                            <div class="space-y-2">
                                ${generateSubjectPerformanceChart(studentData.id, studentData.semester)}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-3">Improvement Suggestions</h4>
                            <div class="space-y-2">
                                ${generateImprovementSuggestions(studentData.id, studentData.semester)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('backButton').style.display = 'block';
        }

        function goBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Remove current page
                const previousPage = navigationHistory[navigationHistory.length - 1];
                
                if (previousPage.page === 'dashboard') {
                    showDashboard();
                } else if (previousPage.page === 'students') {
                    showStudents();
                } else if (previousPage.page === 'attendance') {
                    showAttendance();
                } else if (previousPage.page === 'grades') {
                    showGrades();
                } else {
                    showDashboard();
                }
            } else {
                showDashboard();
            }
        }

        // FAB Menu Functions
        function toggleFabMenu() {
            const fabMenu = document.getElementById('fabMenu');
            const fabOverlay = document.getElementById('fabOverlay');
            const fabButton = document.getElementById('fabButton');
            const fabIcon = document.getElementById('fabIcon');
            
            if (fabMenu.style.display === 'none' || !fabMenu.style.display) {
                // Show menu
                fabMenu.style.display = 'flex';
                fabOverlay.style.display = 'block';
                fabButton.classList.add('active');
                fabIcon.style.transform = 'rotate(45deg)';
            } else {
                // Hide menu
                closeFabMenu();
            }
        }

        function closeFabMenu() {
            const fabMenu = document.getElementById('fabMenu');
            const fabOverlay = document.getElementById('fabOverlay');
            const fabButton = document.getElementById('fabButton');
            const fabIcon = document.getElementById('fabIcon');
            
            fabMenu.style.display = 'none';
            fabOverlay.style.display = 'none';
            fabButton.classList.remove('active');
            fabIcon.style.transform = 'rotate(0deg)';
        }

        // Bulk Actions Functions
        function showBulkActions() {
            // Refresh student list in modal
            const bulkStudentsList = document.getElementById('bulkStudentsList');
            bulkStudentsList.innerHTML = students.map(student => `
                <label class="flex items-center p-2 hover:bg-white rounded-lg cursor-pointer">
                    <input type="checkbox" class="bulk-student-checkbox mr-3" value="${student.id}">
                    <div>
                        <div class="font-semibold text-sm">${student.name}</div>
                        <div class="text-xs text-gray-600">${student.id} • ${getCourseName(student.course)}</div>
                    </div>
                </label>
            `).join('');
            
            openModal('bulkActionsModal');
        }

        function selectAllStudents() {
            const checkboxes = document.querySelectorAll('.bulk-student-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function deselectAllStudents() {
            const checkboxes = document.querySelectorAll('.bulk-student-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function getSelectedStudents() {
            const checkboxes = document.querySelectorAll('.bulk-student-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function bulkMarkAttendance() {
            const selectedStudents = getSelectedStudents();
            if (selectedStudents.length === 0) {
                showError('Please select at least one student');
                return;
            }
            
            const subject = prompt('Enter subject for attendance:');
            if (!subject) return;
            
            const status = prompt('Enter status (present/absent/late):', 'present');
            if (!['present', 'absent', 'late'].includes(status)) {
                showError('Invalid status. Use: present, absent, or late');
                return;
            }
            
            const date = new Date().toISOString().split('T')[0];
            let successCount = 0;
            
            selectedStudents.forEach(studentId => {
                // Check if attendance already exists
                const existingRecord = attendance.find(a => 
                    a.studentId === studentId && 
                    a.subject === subject && 
                    a.date === date
                );
                
                if (!existingRecord) {
                    const newAttendance = {
                        id: attendance.length + 1,
                        studentId,
                        subject,
                        date,
                        status,
                        markedBy: currentUser.email,
                        selfMarked: false,
                        createdAt: new Date().toISOString()
                    };
                    
                    attendance.push(newAttendance);
                    successCount++;
                }
            });
            
            if (successCount > 0) {
                saveData();
                showSuccess(`Attendance marked for ${successCount} students! 📝`);
                closeModal('bulkActionsModal');
            } else {
                showError('No new attendance records created (may already exist)');
            }
        }

        function bulkChangeStatus() {
            const selectedStudents = getSelectedStudents();
            if (selectedStudents.length === 0) {
                showError('Please select at least one student');
                return;
            }
            
            const newStatus = prompt('Enter new status (active/inactive/suspended/graduated):', 'active');
            if (!['active', 'inactive', 'suspended', 'graduated'].includes(newStatus)) {
                showError('Invalid status. Use: active, inactive, suspended, or graduated');
                return;
            }
            
            if (confirm(`Change status to "${newStatus}" for ${selectedStudents.length} selected students?`)) {
                selectedStudents.forEach(studentId => {
                    const studentIndex = students.findIndex(s => s.id === studentId);
                    if (studentIndex > -1) {
                        students[studentIndex].status = newStatus;
                        students[studentIndex].updatedAt = new Date().toISOString();
                    }
                });
                
                saveData();
                showSuccess(`Status updated for ${selectedStudents.length} students! 👥`);
                closeModal('bulkActionsModal');
            }
        }

        function bulkSendNotification() {
            const selectedStudents = getSelectedStudents();
            if (selectedStudents.length === 0) {
                showError('Please select at least one student');
                return;
            }
            
            const message = prompt(`Send notification to ${selectedStudents.length} selected students:\n\nEnter your message:`);
            if (message && message.trim()) {
                // Simulate sending notifications
                setTimeout(() => {
                    showSuccess(`📧 Notification sent to ${selectedStudents.length} students: "${message.trim()}"`);
                    closeModal('bulkActionsModal');
                }, 1000);
            }
        }

        function bulkExportData() {
            const selectedStudents = getSelectedStudents();
            if (selectedStudents.length === 0) {
                showError('Please select at least one student');
                return;
            }
            
            try {
                const exportData = {
                    students: students.filter(s => selectedStudents.includes(s.id)),
                    attendance: attendance.filter(a => selectedStudents.includes(a.studentId)),
                    grades: marks.filter(m => selectedStudents.includes(m.studentId)),
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser.email,
                    college: 'SREE SIDDRAMESHWARA POLYTECHNIC TIPTUR'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `bulk_student_data_${selectedStudents.length}_students_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccess(`Data exported for ${selectedStudents.length} students! 📄`);
                closeModal('bulkActionsModal');
            } catch (error) {
                showError('Export failed. Please try again.');
            }
        }

        // Quick Actions Functions
        function showQuickAttendance() {
            // Refresh student list in modal
            const quickAttendanceList = document.getElementById('quickAttendanceList');
            quickAttendanceList.innerHTML = students.filter(s => s.status === 'active').map(student => `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-2">
                    <div>
                        <div class="font-semibold text-sm">${student.name}</div>
                        <div class="text-xs text-gray-600">${student.id}</div>
                    </div>
                    <select class="quick-attendance-status input-field text-sm" data-student-id="${student.id}">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                    </select>
                </div>
            `).join('');
            
            openModal('quickAttendanceModal');
        }

        function submitQuickAttendance(event) {
            event.preventDefault();
            
            const subject = document.getElementById('quickAttendanceSubject').value;
            const date = document.getElementById('quickAttendanceDate').value;
            
            if (!subject || !date) {
                showError('Please fill all required fields');
                return;
            }
            
            // Check if it's Sunday
            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay();
            
            if (dayOfWeek === 0) {
                const confirmSunday = confirm('📅 This is a Sunday! Are you sure you want to mark attendance?');
                if (!confirmSunday) return;
            }
            
            const submitButton = document.getElementById('submitQuickAttendanceButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner mr-2"></div>Submitting...';
            
            setTimeout(() => {
                const statusSelects = document.querySelectorAll('.quick-attendance-status');
                let successCount = 0;
                let duplicateCount = 0;
                
                statusSelects.forEach(select => {
                    const studentId = select.dataset.studentId;
                    const status = select.value;
                    
                    // Check if attendance already exists
                    const existingRecord = attendance.find(a => 
                        a.studentId === studentId && 
                        a.subject === subject && 
                        a.date === date
                    );
                    
                    if (!existingRecord) {
                        const newAttendance = {
                            id: attendance.length + 1,
                            studentId,
                            subject,
                            date,
                            status,
                            time: new Date().toTimeString().slice(0,5),
                            markedBy: currentUser.email,
                            selfMarked: false,
                            createdAt: new Date().toISOString()
                        };
                        
                        attendance.push(newAttendance);
                        successCount++;
                    } else {
                        duplicateCount++;
                    }
                });
                
                saveData();
                
                let message = `✅ Quick attendance completed! ${successCount} records added.`;
                if (duplicateCount > 0) {
                    message += ` ${duplicateCount} duplicates skipped.`;
                }
                
                showSuccess(message);
                closeModal('quickAttendanceModal');
                
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>Submit Attendance';
            }, 1500);
        }

        function showQuickGrade() {
            // Refresh student list in modal
            const quickGradeList = document.getElementById('quickGradeList');
            quickGradeList.innerHTML = students.filter(s => s.status === 'active').map(student => `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-2">
                    <div>
                        <div class="font-semibold text-sm">${student.name}</div>
                        <div class="text-xs text-gray-600">${student.id}</div>
                    </div>
                    <input type="number" class="quick-grade-marks input-field text-sm w-24" 
                           data-student-id="${student.id}" min="0" placeholder="Marks">
                </div>
            `).join('');
            
            openModal('quickGradeModal');
        }

        function submitQuickGrade(event) {
            event.preventDefault();
            
            const subject = document.getElementById('quickGradeSubject').value;
            const examType = document.getElementById('quickGradeExamType').value;
            const date = document.getElementById('quickGradeDate').value;
            const totalMarks = parseInt(document.getElementById('quickGradeTotalMarks').value);
            
            if (!subject || !examType || !date || !totalMarks) {
                showError('Please fill all required fields');
                return;
            }
            
            if (totalMarks <= 0 || totalMarks > 1000) {
                showError('Total marks must be between 1 and 1000');
                return;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const selectedDate = new Date(date);
            
            if (selectedDate > today) {
                showError('Cannot add grades for future dates');
                return;
            }
            
            const submitButton = document.getElementById('submitQuickGradeButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner mr-2"></div>Submitting...';
            
            setTimeout(() => {
                const marksInputs = document.querySelectorAll('.quick-grade-marks');
                let successCount = 0;
                let skipCount = 0;
                
                marksInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const obtainedMarks = parseInt(input.value);
                    
                    // Skip if no marks entered or invalid
                    if (!input.value || isNaN(obtainedMarks) || obtainedMarks < 0 || obtainedMarks > totalMarks) {
                        skipCount++;
                        return;
                    }
                    
                    // Check for duplicate entries
                    const existingGrade = marks.find(m => 
                        m.studentId === studentId && 
                        m.subject === subject && 
                        m.examType === examType && 
                        m.date === date
                    );
                    
                    if (!existingGrade) {
                        const newGrade = {
                            id: marks.length + 1,
                            studentId,
                            subject,
                            examType,
                            date,
                            totalMarks,
                            obtainedMarks,
                            addedBy: currentUser.email,
                            selfReported: false,
                            verified: true,
                            createdAt: new Date().toISOString()
                        };
                        
                        marks.push(newGrade);
                        successCount++;
                    } else {
                        skipCount++;
                    }
                });
                
                saveData();
                
                let message = `✅ Quick grade entry completed! ${successCount} grades added.`;
                if (skipCount > 0) {
                    message += ` ${skipCount} entries skipped (empty/invalid/duplicate).`;
                }
                
                showSuccess(message);
                closeModal('quickGradeModal');
                
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>Submit Grades';
            }, 1500);
        }

        // Approval Functions
        function showPendingApprovals() {
            // Refresh pending grades list
            const pendingGradesList = document.getElementById('pendingGradesList');
            const pendingGrades = marks.filter(m => m.selfReported && !m.verified);
            
            pendingGradesList.innerHTML = pendingGrades.map(grade => {
                const student = students.find(s => s.id === grade.studentId);
                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                return `
                    <div class="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl mb-3 border border-yellow-200">
                        <div class="flex-1">
                            <div class="font-semibold text-sm">${student ? student.name : 'Unknown'}</div>
                            <div class="text-xs text-gray-600">${getSubjectName(grade.subject)} • ${formatExamType(grade.examType)}</div>
                            <div class="text-sm font-bold text-purple-600">${grade.obtainedMarks}/${grade.totalMarks} (${percentage}%)</div>
                            <div class="text-xs text-gray-500">Reported on ${formatDate(grade.date)}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveGrade(${grade.id})" class="btn-success text-xs px-3 py-2">
                                <i class="fas fa-check mr-1"></i>Approve
                            </button>
                            <button onclick="rejectGrade(${grade.id})" class="btn-danger text-xs px-3 py-2">
                                <i class="fas fa-times mr-1"></i>Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-8">No pending grade verifications</p>';
            
            // Refresh student approvals list
            const studentApprovalsList = document.getElementById('studentApprovalsList');
            const inactiveStudents = students.filter(s => s.status === 'inactive' || s.status === 'suspended');
            
            studentApprovalsList.innerHTML = inactiveStudents.map(student => `
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl mb-3 border border-red-200">
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${student.name}</div>
                        <div class="text-xs text-gray-600">${student.id} • ${getCourseName(student.course)}</div>
                        <div class="text-sm">
                            <span class="badge ${student.status === 'inactive' ? 'badge-secondary' : 'badge-danger'}">${student.status.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="approveStudent('${student.id}')" class="btn-success text-xs px-3 py-2">
                            <i class="fas fa-user-check mr-1"></i>Activate
                        </button>
                        <button onclick="viewStudent('${student.id}'); closeModal('pendingApprovalsModal');" class="btn-info text-xs px-3 py-2">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 text-center py-8">All students are active</p>';
            
            openModal('pendingApprovalsModal');
        }

        function approveGrade(gradeId) {
            const grade = marks.find(m => m.id === gradeId);
            if (!grade) {
                showError('Grade not found');
                return;
            }
            
            const student = students.find(s => s.id === grade.studentId);
            const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
            
            if (confirm(`Approve grade for ${student ? student.name : 'Unknown Student'}?\n\n${getSubjectName(grade.subject)} - ${formatExamType(grade.examType)}\n${grade.obtainedMarks}/${grade.totalMarks} (${percentage}%)`)) {
                const gradeIndex = marks.findIndex(m => m.id === gradeId);
                if (gradeIndex > -1) {
                    marks[gradeIndex].verified = true;
                    marks[gradeIndex].verifiedBy = currentUser.email;
                    marks[gradeIndex].verifiedAt = new Date().toISOString();
                    
                    saveData();
                    showSuccess(`✅ Grade approved for ${student ? student.name : 'student'}! ${grade.obtainedMarks}/${grade.totalMarks} (${percentage}%)`);
                    
                    // Refresh the approvals modal
                    showPendingApprovals();
                }
            }
        }

        function rejectGrade(gradeId) {
            const grade = marks.find(m => m.id === gradeId);
            if (!grade) {
                showError('Grade not found');
                return;
            }
            
            const student = students.find(s => s.id === grade.studentId);
            const reason = prompt(`Reject grade for ${student ? student.name : 'Unknown Student'}?\n\nPlease provide a reason for rejection:`);
            
            if (reason && reason.trim()) {
                const gradeIndex = marks.findIndex(m => m.id === gradeId);
                if (gradeIndex > -1) {
                    // Remove the rejected grade
                    marks.splice(gradeIndex, 1);
                    
                    saveData();
                    showSuccess(`❌ Grade rejected for ${student ? student.name : 'student'}. Reason: ${reason.trim()}`);
                    
                    // Refresh the approvals modal
                    showPendingApprovals();
                }
            }
        }

        function approveStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            if (confirm(`Activate ${student.name}?\n\nThis will change their status from "${student.status}" to "active".`)) {
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex > -1) {
                    students[studentIndex].status = 'active';
                    students[studentIndex].activatedBy = currentUser.email;
                    students[studentIndex].activatedAt = new Date().toISOString();
                    
                    saveData();
                    showSuccess(`✅ ${student.name} has been activated successfully!`);
                    
                    // Refresh the approvals modal
                    showPendingApprovals();
                }
            }
        }

        function exportData() {
            try {
                const data = {
                    students: students,
                    attendance: attendance,
                    marks: marks,
                    exportDate: new Date().toISOString(),
                    college: 'SREE SIDDRAMESHWARA POLYTECHNIC TIPTUR'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `student_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccess('Data exported successfully!');
            } catch (error) {
                showError('Export failed. Please try again.');
            }
        }

        // Helper functions for student attendance
        function getSubjectsForSemester(semester) {
            return subjects[semester] || [];
        }

        function markSelfAttendance(event) {
            event.preventDefault();
            
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) {
                showError('Student record not found');
                return;
            }
            
            const subject = document.getElementById('selfAttendanceSubject').value;
            const date = document.getElementById('selfAttendanceDate').value;
            const status = document.getElementById('selfAttendanceStatus').value;
            const time = document.getElementById('selfAttendanceTime').value;
            
            if (!subject || !date || !status) {
                showError('Please fill all required fields');
                return;
            }
            
            // Check if it's Sunday
            const selectedDate = new Date(date);
            const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            if (dayOfWeek === 0) {
                const confirmSunday = confirm('📅 Today is Sunday! Are you sure you want to mark attendance? Classes are usually not held on Sundays.');
                if (!confirmSunday) {
                    return;
                }
            }
            
            // Check if attendance already exists for this student, subject, and date
            const existingRecord = attendance.find(a => 
                a.studentId === studentData.id && 
                a.subject === subject && 
                a.date === date
            );
            
            if (existingRecord) {
                showError('Attendance already marked for this subject and date');
                return;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate > today) {
                showError('Cannot mark attendance for future dates');
                return;
            }
            
            const newAttendance = {
                id: attendance.length + 1,
                studentId: studentData.id,
                subject,
                date,
                status,
                time: time || new Date().toTimeString().slice(0,5),
                markedBy: currentUser.email,
                selfMarked: true,
                createdAt: new Date().toISOString()
            };
            
            attendance.push(newAttendance);
            saveData();
            
            showSuccess(`Attendance marked successfully! Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`);
            
            // Reset form
            event.target.reset();
            document.getElementById('selfAttendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('selfAttendanceTime').value = new Date().toTimeString().slice(0,5);
            
            // Re-render table
            document.getElementById('myAttendanceTableBody').innerHTML = renderMyAttendanceTable(studentData.id);
            
            // Update stats by refreshing the page
            showMyAttendance();
        }

        function renderMyAttendanceTable(studentId) {
            const myAttendance = attendance.filter(a => a.studentId === studentId).reverse();
            
            if (myAttendance.length === 0) {
                return '<tr><td colspan="6" class="text-center py-8 text-gray-500">No attendance records found</td></tr>';
            }
            
            return myAttendance.map(record => `
                <tr>
                    <td>${formatDate(record.date)}</td>
                    <td>${getSubjectName(record.subject)}</td>
                    <td>
                        <span class="badge ${getAttendanceStatusColor(record.status)}">
                            ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                        </span>
                    </td>
                    <td>${record.time || 'N/A'}</td>
                    <td>
                        <div class="text-sm">${record.selfMarked ? 'Self' : 'Admin'}</div>
                        <div class="text-xs text-gray-500">${record.markedBy}</div>
                    </td>
                    <td>
                        ${record.selfMarked ? 
                            '<span class="badge badge-info text-xs">Self-Marked</span>' : 
                            '<span class="badge badge-success text-xs">Official</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        function filterMyAttendanceBySubject(subject) {
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) return;
            
            const tbody = document.getElementById('myAttendanceTableBody');
            if (subject) {
                const filtered = attendance.filter(a => a.studentId === studentData.id && a.subject === subject).reverse();
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No records found for this subject</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(record => `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td>${getSubjectName(record.subject)}</td>
                            <td>
                                <span class="badge ${getAttendanceStatusColor(record.status)}">
                                    ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                </span>
                            </td>
                            <td>${record.time || 'N/A'}</td>
                            <td>
                                <div class="text-sm">${record.selfMarked ? 'Self' : 'Admin'}</div>
                                <div class="text-xs text-gray-500">${record.markedBy}</div>
                            </td>
                            <td>
                                ${record.selfMarked ? 
                                    '<span class="badge badge-info text-xs">Self-Marked</span>' : 
                                    '<span class="badge badge-success text-xs">Official</span>'
                                }
                            </td>
                        </tr>
                    `).join('');
                }
            } else {
                tbody.innerHTML = renderMyAttendanceTable(studentData.id);
            }
        }

        function filterMyAttendanceByMonth(month) {
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) return;
            
            const tbody = document.getElementById('myAttendanceTableBody');
            if (month) {
                const filtered = attendance.filter(a => 
                    a.studentId === studentData.id && 
                    a.date.startsWith(month)
                ).reverse();
                
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No records found for this month</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(record => `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td>${getSubjectName(record.subject)}</td>
                            <td>
                                <span class="badge ${getAttendanceStatusColor(record.status)}">
                                    ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                </span>
                            </td>
                            <td>${record.time || 'N/A'}</td>
                            <td>
                                <div class="text-sm">${record.selfMarked ? 'Self' : 'Admin'}</div>
                                <div class="text-xs text-gray-500">${record.markedBy}</div>
                            </td>
                            <td>
                                ${record.selfMarked ? 
                                    '<span class="badge badge-info text-xs">Self-Marked</span>' : 
                                    '<span class="badge badge-success text-xs">Official</span>'
                                }
                            </td>
                        </tr>
                    `).join('');
                }
            } else {
                tbody.innerHTML = renderMyAttendanceTable(studentData.id);
            }
        }

        function generateSubjectAttendanceSummary(studentId, semester) {
            const myAttendance = attendance.filter(a => a.studentId === studentId);
            const semesterSubjects = getSubjectsForSemester(semester);
            
            if (semesterSubjects.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No subjects found for your semester</p>';
            }
            
            return semesterSubjects.map(subject => {
                const subjectAttendance = myAttendance.filter(a => a.subject === subject.value);
                const totalClasses = subjectAttendance.length;
                const presentClasses = subjectAttendance.filter(a => a.status === 'present').length;
                const attendanceRate = totalClasses > 0 ? Math.round((presentClasses / totalClasses) * 100) : 0;
                
                return `
                    <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl">
                        <div>
                            <h4 class="font-semibold text-sm">${subject.name}</h4>
                            <p class="text-xs text-gray-600">${totalClasses} total classes</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${attendanceRate >= 75 ? 'text-green-600' : 'text-red-600'}">
                                ${attendanceRate}%
                            </div>
                            <div class="text-xs text-gray-600">
                                ${presentClasses}/${totalClasses} present
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // AI and ML Functions
        function generateAIPrediction(studentId) {
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            const studentAttendance = attendance.filter(a => a.studentId === studentId);
            
            if (studentGrades.length === 0) {
                return {
                    predictedGrade: 'B+',
                    riskLevel: 'Low',
                    insights: [
                        'No grade data available for accurate prediction',
                        'Focus on consistent attendance and participation',
                        'Submit assignments on time to build a strong foundation'
                    ]
                };
            }
            
            // Calculate current performance metrics
            const averageGrade = studentGrades.reduce((sum, grade) => 
                sum + calculatePercentage(grade.obtainedMarks, grade.totalMarks), 0) / studentGrades.length;
            
            const attendanceRate = studentAttendance.length > 0 ? 
                (studentAttendance.filter(a => a.status === 'present').length / studentAttendance.length) * 100 : 0;
            
            // AI prediction algorithm (simplified ML model)
            let predictedPercentage = averageGrade;
            
            // Attendance impact (attendance affects final grade by up to 15%)
            if (attendanceRate >= 90) predictedPercentage += 5;
            else if (attendanceRate >= 75) predictedPercentage += 2;
            else if (attendanceRate < 60) predictedPercentage -= 10;
            
            // Trend analysis (check if grades are improving or declining)
            if (studentGrades.length >= 3) {
                const recentGrades = studentGrades.slice(-3);
                const trend = recentGrades[2].obtainedMarks - recentGrades[0].obtainedMarks;
                if (trend > 0) predictedPercentage += 3; // Improving trend
                else if (trend < -5) predictedPercentage -= 2; // Declining trend
            }
            
            // Subject diversity bonus (performing well across multiple subjects)
            const uniqueSubjects = [...new Set(studentGrades.map(g => g.subject))];
            if (uniqueSubjects.length >= 4) predictedPercentage += 2;
            
            // Ensure prediction is within bounds
            predictedPercentage = Math.max(0, Math.min(100, Math.round(predictedPercentage)));
            
            // Determine risk level
            let riskLevel = 'Low';
            if (predictedPercentage < 50) riskLevel = 'High';
            else if (predictedPercentage < 70) riskLevel = 'Medium';
            
            // Generate insights based on AI analysis
            const insights = [];
            
            if (averageGrade >= 85) {
                insights.push('Excellent academic performance! Keep up the great work');
            } else if (averageGrade >= 70) {
                insights.push('Good performance with room for improvement');
            } else {
                insights.push('Focus needed on improving study habits and exam preparation');
            }
            
            if (attendanceRate >= 90) {
                insights.push('Outstanding attendance record positively impacts your grades');
            } else if (attendanceRate < 75) {
                insights.push('Improve attendance - it significantly affects academic success');
            }
            
            if (studentGrades.length >= 3) {
                const recentAvg = studentGrades.slice(-2).reduce((sum, g) => 
                    sum + calculatePercentage(g.obtainedMarks, g.totalMarks), 0) / 2;
                if (recentAvg > averageGrade) {
                    insights.push('Recent performance shows positive improvement trend');
                } else if (recentAvg < averageGrade - 5) {
                    insights.push('Recent grades show decline - consider additional study support');
                }
            }
            
            // Subject-specific insights
            const subjectPerformance = {};
            studentGrades.forEach(grade => {
                if (!subjectPerformance[grade.subject]) {
                    subjectPerformance[grade.subject] = [];
                }
                subjectPerformance[grade.subject].push(calculatePercentage(grade.obtainedMarks, grade.totalMarks));
            });
            
            let weakestSubject = null;
            let strongestSubject = null;
            let lowestAvg = 100;
            let highestAvg = 0;
            
            Object.keys(subjectPerformance).forEach(subject => {
                const avg = subjectPerformance[subject].reduce((a, b) => a + b, 0) / subjectPerformance[subject].length;
                if (avg < lowestAvg) {
                    lowestAvg = avg;
                    weakestSubject = subject;
                }
                if (avg > highestAvg) {
                    highestAvg = avg;
                    strongestSubject = subject;
                }
            });
            
            if (weakestSubject && lowestAvg < 70) {
                insights.push(`Focus extra attention on ${getSubjectName(weakestSubject)} (${Math.round(lowestAvg)}% avg)`);
            }
            
            if (strongestSubject && highestAvg > 85) {
                insights.push(`Excellent performance in ${getSubjectName(strongestSubject)} (${Math.round(highestAvg)}% avg)`);
            }
            
            return {
                predictedGrade: getLetterGrade(predictedPercentage),
                riskLevel: riskLevel,
                insights: insights.slice(0, 4) // Limit to 4 insights
            };
        }

        function addSelfGrade(event) {
            event.preventDefault();
            
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) {
                showError('Student record not found');
                return;
            }
            
            const subject = document.getElementById('selfGradeSubject').value;
            const examType = document.getElementById('selfGradeExamType').value;
            const date = document.getElementById('selfGradesDate').value;
            const totalMarks = parseInt(document.getElementById('selfGradeTotalMarks').value);
            const obtainedMarks = parseInt(document.getElementById('selfGradeObtainedMarks').value);
            
            if (!subject || !examType || !date || !totalMarks || obtainedMarks === undefined) {
                showError('Please fill all required fields');
                return;
            }
            
            if (obtainedMarks > totalMarks) {
                showError('Obtained marks cannot be greater than total marks');
                return;
            }
            
            if (obtainedMarks < 0) {
                showError('Obtained marks cannot be negative');
                return;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(date);
            
            if (selectedDate > today) {
                showError('Cannot report grades for future dates');
                return;
            }
            
            const newGrade = {
                id: marks.length + 1,
                studentId: studentData.id,
                subject,
                examType,
                date,
                totalMarks,
                obtainedMarks,
                addedBy: currentUser.email,
                selfReported: true,
                verified: false,
                createdAt: new Date().toISOString()
            };
            
            marks.push(newGrade);
            saveData();
            
            const percentage = calculatePercentage(obtainedMarks, totalMarks);
            showSuccess(`Grade reported successfully! ${obtainedMarks}/${totalMarks} (${percentage}%) - Pending admin verification`);
            
            // Reset form
            event.target.reset();
            document.getElementById('selfGradesDate').value = new Date().toISOString().split('T')[0];
            
            // Refresh the grades page to show updated data
            showMyGrades();
        }

        function renderMyGradesTable(studentId) {
            const myGrades = marks.filter(m => m.studentId === studentId).reverse();
            
            if (myGrades.length === 0) {
                return '<tr><td colspan="8" class="text-center py-8 text-gray-500">No grade records found</td></tr>';
            }
            
            return myGrades.map(grade => {
                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                const gradePoints = getGradePoints(percentage);
                return `
                    <tr>
                        <td>${formatDate(grade.date)}</td>
                        <td>${getSubjectName(grade.subject)}</td>
                        <td>${formatExamType(grade.examType)}</td>
                        <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                        <td>
                            <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                ${percentage}%
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getGradeBadgeColor(percentage)}">
                                ${getLetterGrade(percentage)}
                            </span>
                        </td>
                        <td>
                            <span class="font-bold text-purple-600">${gradePoints}/10</span>
                        </td>
                        <td>
                            ${grade.verified ? 
                                '<span class="badge badge-success">Verified</span>' : 
                                grade.selfReported ? 
                                    '<span class="badge badge-warning">Pending</span>' : 
                                    '<span class="badge badge-info">Official</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterMyGradesBySubject(subject) {
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) return;
            
            const tbody = document.getElementById('myGradesTableBody');
            if (subject) {
                const filtered = marks.filter(m => m.studentId === studentData.id && m.subject === subject).reverse();
                tbody.innerHTML = filtered.length > 0 ? filtered.map(grade => {
                    const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                    return `
                        <tr>
                            <td>${formatDate(grade.date)}</td>
                            <td>${getSubjectName(grade.subject)}</td>
                            <td>${formatExamType(grade.examType)}</td>
                            <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                            <td>
                                <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                    ${percentage}%
                                </span>
                            </td>
                            <td>
                                <span class="badge ${getGradeBadgeColor(percentage)}">
                                    ${getLetterGrade(percentage)}
                                </span>
                            </td>
                            <td>
                                ${grade.verified ? 
                                    '<span class="badge badge-success">Verified</span>' : 
                                    grade.selfReported ? 
                                        '<span class="badge badge-warning">Pending</span>' : 
                                        '<span class="badge badge-info">Official</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('') : '<tr><td colspan="7" class="text-center py-8 text-gray-500">No records found for this subject</td></tr>';
            } else {
                tbody.innerHTML = renderMyGradesTable(studentData.id);
            }
        }

        function filterMyGradesByType(examType) {
            const studentData = students.find(s => s.email === currentUser.email);
            if (!studentData) return;
            
            const tbody = document.getElementById('myGradesTableBody');
            if (examType) {
                const filtered = marks.filter(m => m.studentId === studentData.id && m.examType === examType).reverse();
                tbody.innerHTML = filtered.length > 0 ? filtered.map(grade => {
                    const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                    return `
                        <tr>
                            <td>${formatDate(grade.date)}</td>
                            <td>${getSubjectName(grade.subject)}</td>
                            <td>${formatExamType(grade.examType)}</td>
                            <td class="font-semibold">${grade.obtainedMarks}/${grade.totalMarks}</td>
                            <td>
                                <span class="font-bold ${getGradeColor(grade.obtainedMarks, grade.totalMarks)}">
                                    ${percentage}%
                                </span>
                            </td>
                            <td>
                                <span class="badge ${getGradeBadgeColor(percentage)}">
                                    ${getLetterGrade(percentage)}
                                </span>
                            </td>
                            <td>
                                ${grade.verified ? 
                                    '<span class="badge badge-success">Verified</span>' : 
                                    grade.selfReported ? 
                                        '<span class="badge badge-warning">Pending</span>' : 
                                        '<span class="badge badge-info">Official</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('') : '<tr><td colspan="7" class="text-center py-8 text-gray-500">No records found for this exam type</td></tr>';
            } else {
                tbody.innerHTML = renderMyGradesTable(studentData.id);
            }
        }

        function generateSemesterGradesSummary(studentId, semester) {
            const semesterSubjects = getSubjectsForSemester(semester);
            const studentGrades = marks.filter(m => m.studentId === studentId);
            
            if (semesterSubjects.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No subjects found for your semester</p>';
            }
            
            return semesterSubjects.map(subject => {
                const subjectGrades = studentGrades.filter(g => g.subject === subject.value);
                const verifiedGrades = subjectGrades.filter(g => g.verified);
                
                let averageGrade = 0;
                let status = 'No grades';
                let statusColor = 'text-gray-500';
                
                if (verifiedGrades.length > 0) {
                    averageGrade = Math.round(verifiedGrades.reduce((sum, grade) => 
                        sum + calculatePercentage(grade.obtainedMarks, grade.totalMarks), 0) / verifiedGrades.length);
                    status = `${averageGrade}% (${getLetterGrade(averageGrade)})`;
                    statusColor = averageGrade >= 80 ? 'text-green-600' : averageGrade >= 60 ? 'text-yellow-600' : 'text-red-600';
                } else if (subjectGrades.length > 0) {
                    status = `${subjectGrades.length} pending verification`;
                    statusColor = 'text-orange-600';
                }
                
                return `
                    <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl">
                        <div>
                            <h4 class="font-semibold text-sm">${subject.name}</h4>
                            <p class="text-xs text-gray-600">${verifiedGrades.length} verified grades</p>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${statusColor}">
                                ${status}
                            </div>
                            ${subjectGrades.filter(g => !g.verified).length > 0 ? 
                                `<div class="text-xs text-orange-600">${subjectGrades.filter(g => !g.verified).length} pending</div>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateSubjectPerformanceChart(studentId, semester) {
            const semesterSubjects = getSubjectsForSemester(semester);
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            
            return semesterSubjects.map(subject => {
                const subjectGrades = studentGrades.filter(g => g.subject === subject.value);
                let performance = 0;
                let performanceText = 'No data';
                let barColor = 'bg-gray-300';
                
                if (subjectGrades.length > 0) {
                    performance = Math.round(subjectGrades.reduce((sum, grade) => 
                        sum + calculatePercentage(grade.obtainedMarks, grade.totalMarks), 0) / subjectGrades.length);
                    performanceText = `${performance}%`;
                    
                    if (performance >= 85) barColor = 'bg-green-500';
                    else if (performance >= 70) barColor = 'bg-blue-500';
                    else if (performance >= 60) barColor = 'bg-yellow-500';
                    else barColor = 'bg-red-500';
                }
                
                return `
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">${subject.name}</span>
                            <span class="font-semibold">${performanceText}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full transition-all duration-500" style="width: ${performance}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateImprovementSuggestions(studentId, semester) {
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            const studentAttendance = attendance.filter(a => a.studentId === studentId);
            const suggestions = [];
            
            // Analyze attendance
            const attendanceRate = studentAttendance.length > 0 ? 
                (studentAttendance.filter(a => a.status === 'present').length / studentAttendance.length) * 100 : 0;
            
            if (attendanceRate < 75) {
                suggestions.push({
                    icon: '📅',
                    title: 'Improve Attendance',
                    description: `Current: ${Math.round(attendanceRate)}%. Aim for 90%+ attendance to boost grades.`,
                    priority: 'high'
                });
            }
            
            // Analyze grade patterns
            if (studentGrades.length > 0) {
                const averageGrade = studentGrades.reduce((sum, grade) => 
                    sum + calculatePercentage(grade.obtainedMarks, grade.totalMarks), 0) / studentGrades.length;
                
                if (averageGrade < 70) {
                    suggestions.push({
                        icon: '📚',
                        title: 'Study Strategy',
                        description: 'Consider forming study groups and seeking help from teachers.',
                        priority: 'high'
                    });
                }
                
                // Find weakest subject
                const subjectPerformance = {};
                studentGrades.forEach(grade => {
                    if (!subjectPerformance[grade.subject]) {
                        subjectPerformance[grade.subject] = [];
                    }
                    subjectPerformance[grade.subject].push(calculatePercentage(grade.obtainedMarks, grade.totalMarks));
                });
                
                let weakestSubject = null;
                let lowestAvg = 100;
                
                Object.keys(subjectPerformance).forEach(subject => {
                    const avg = subjectPerformance[subject].reduce((a, b) => a + b, 0) / subjectPerformance[subject].length;
                    if (avg < lowestAvg) {
                        lowestAvg = avg;
                        weakestSubject = subject;
                    }
                });
                
                if (weakestSubject && lowestAvg < 70) {
                    suggestions.push({
                        icon: '🎯',
                        title: 'Focus Area',
                        description: `Extra attention needed in ${getSubjectName(weakestSubject)} (${Math.round(lowestAvg)}% avg).`,
                        priority: 'medium'
                    });
                }
            }
            
            // General suggestions
            if (suggestions.length === 0) {
                suggestions.push({
                    icon: '🌟',
                    title: 'Keep It Up!',
                    description: 'Great performance! Continue with consistent study habits.',
                    priority: 'low'
                });
            }
            
            suggestions.push({
                icon: '⏰',
                title: 'Time Management',
                description: 'Create a study schedule and stick to it for better results.',
                priority: 'medium'
            });
            
            return suggestions.slice(0, 4).map(suggestion => {
                const priorityColor = suggestion.priority === 'high' ? 'border-red-200 bg-red-50' : 
                                    suggestion.priority === 'medium' ? 'border-yellow-200 bg-yellow-50' : 
                                    'border-green-200 bg-green-50';
                
                return `
                    <div class="p-3 rounded-xl border ${priorityColor}">
                        <div class="flex items-start">
                            <span class="text-lg mr-3">${suggestion.icon}</span>
                            <div>
                                <h5 class="font-semibold text-sm">${suggestion.title}</h5>
                                <p class="text-xs text-gray-600 mt-1">${suggestion.description}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateDetailedAnalysis(studentId) {
            const analysis = generateAIPrediction(studentId);
            const studentData = students.find(s => s.id === studentId);
            
            showSuccess(`🤖 AI Analysis for ${studentData.name}: Predicted Grade ${analysis.predictedGrade}, Risk Level: ${analysis.riskLevel}. Check the insights above for detailed recommendations!`);
        }

        // Profile Management Functions
        function updateProfile(event) {
            event.preventDefault();
            clearAllErrors('updateProfile');
            
            const name = document.getElementById('profileName').value.trim();
            const email = document.getElementById('profileEmail').value.trim().toLowerCase();
            const phone = document.getElementById('profilePhone')?.value.trim() || '';
            const semester = document.getElementById('profileSemester')?.value || null;
            
            let hasErrors = false;
            
            // Name validation
            if (!name || name.length < 2) {
                showFieldError('profileName', 'Name must be at least 2 characters');
                hasErrors = true;
            }
            
            // Email validation
            if (!email || !validateEmail(email)) {
                showFieldError('profileEmail', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            // Check if email is already taken by another user
            const existingUser = users.find(u => u.email.toLowerCase() === email && u.email !== currentUser.email);
            if (existingUser) {
                showFieldError('profileEmail', 'Email already exists! Please use a different email.');
                hasErrors = true;
            }
            
            // Phone validation (if provided)
            if (phone && !validatePhone(phone)) {
                showFieldError('profilePhone', 'Please enter a valid 10-digit phone number');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const updateButton = document.getElementById('updateProfileButton');
            updateButton.disabled = true;
            updateButton.innerHTML = '<div class="loading-spinner mr-2"></div>Updating Profile...';
            
            setTimeout(() => {
                // Update user data
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex > -1) {
                    const oldEmail = users[userIndex].email;
                    users[userIndex].name = name;
                    users[userIndex].email = email;
                    
                    // Update current user
                    currentUser.name = name;
                    currentUser.email = email;
                    
                    // Update student data if user is a student
                    if (currentUser.role === 'student') {
                        const studentIndex = students.findIndex(s => s.email === oldEmail);
                        if (studentIndex > -1) {
                            students[studentIndex].name = name;
                            students[studentIndex].email = email;
                            if (phone !== undefined) students[studentIndex].phone = phone;
                            if (semester) {
                                students[studentIndex].semester = parseInt(semester);
                                // Update user semester too
                                users[userIndex].semester = parseInt(semester);
                                currentUser.semester = parseInt(semester);
                            }
                        }
                        
                        // Update attendance and marks records
                        attendance.forEach(record => {
                            if (record.markedBy === oldEmail) {
                                record.markedBy = email;
                            }
                        });
                        
                        marks.forEach(record => {
                            if (record.addedBy === oldEmail) {
                                record.addedBy = email;
                            }
                        });
                    }
                    
                    saveData();
                    showSuccess('Profile updated successfully! 🎉');
                    
                    // Update header
                    document.getElementById('headerUserName').textContent = name;
                    
                    // Refresh profile page to show updated data
                    showMyProfile();
                } else {
                    showError('User not found. Please try logging in again.');
                }
                
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Profile';
            }, 1500);
        }

        function changePassword(event) {
            event.preventDefault();
            clearAllErrors('changePassword');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            let hasErrors = false;
            
            // Current password validation
            if (!currentPassword) {
                showFieldError('currentPassword', 'Please enter your current password');
                hasErrors = true;
            }
            
            // New password validation
            if (!newPassword || newPassword.length < 6) {
                showFieldError('newPassword', 'Password must be at least 6 characters');
                hasErrors = true;
            } else if (!/(?=.*[a-zA-Z])(?=.*[0-9])/.test(newPassword)) {
                showFieldError('newPassword', 'Password must contain both letters and numbers');
                hasErrors = true;
            }
            
            // Confirm password validation
            if (!confirmPassword) {
                showFieldError('confirmPassword', 'Please confirm your new password');
                hasErrors = true;
            } else if (newPassword !== confirmPassword) {
                showFieldError('confirmPassword', 'Passwords do not match');
                hasErrors = true;
            }
            
            // Check if new password is same as current
            if (newPassword === currentPassword) {
                showFieldError('newPassword', 'New password must be different from current password');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const changeButton = document.getElementById('changePasswordButton');
            changeButton.disabled = true;
            changeButton.innerHTML = '<div class="loading-spinner mr-2"></div>Changing Password...';
            
            setTimeout(() => {
                // Verify current password
                const user = users.find(u => u.email === currentUser.email);
                if (!user || user.password !== currentPassword) {
                    showError('Current password is incorrect');
                    changeButton.disabled = false;
                    changeButton.innerHTML = '<i class="fas fa-key mr-2"></i>Change Password';
                    return;
                }
                
                // Update password
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex > -1) {
                    users[userIndex].password = newPassword;
                    saveData();
                    
                    showSuccess('Password changed successfully! 🔒');
                    
                    // Clear form
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showError('User not found. Please try logging in again.');
                }
                
                changeButton.disabled = false;
                changeButton.innerHTML = '<i class="fas fa-key mr-2"></i>Change Password';
            }, 2000);
        }

        function exportProfileData() {
            try {
                const userData = users.find(u => u.email === currentUser.email);
                const studentData = currentUser.role === 'student' ? students.find(s => s.email === currentUser.email) : null;
                
                let exportData = {
                    profile: {
                        name: userData.name,
                        email: userData.email,
                        role: userData.role,
                        memberSince: userData.createdAt
                    },
                    exportDate: new Date().toISOString(),
                    college: 'SREE SIDDRAMESHWARA POLYTECHNIC TIPTUR'
                };
                
                if (currentUser.role === 'student' && studentData) {
                    exportData.student = {
                        id: studentData.id,
                        course: studentData.course,
                        semester: studentData.semester,
                        phone: studentData.phone,
                        cgpa: calculateCGPA(studentData.id),
                        attendanceRate: calculateStudentAttendance(studentData.id)
                    };
                    
                    exportData.attendance = attendance.filter(a => a.studentId === studentData.id);
                    exportData.grades = marks.filter(m => m.studentId === studentData.id);
                } else if (currentUser.role === 'admin') {
                    exportData.adminData = {
                        totalStudents: students.length,
                        totalAttendanceRecords: attendance.length,
                        totalGradeRecords: marks.length
                    };
                }
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${userData.name.replace(/\s+/g, '_')}_profile_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccess('Profile data exported successfully! 📄');
            } catch (error) {
                showError('Export failed. Please try again.');
            }
        }

        function generateGradeDistribution(studentId) {
            const studentGrades = marks.filter(m => m.studentId === studentId && m.verified);
            
            if (studentGrades.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No verified grades available</p>';
            }
            
            const gradeCount = {
                'A+': 0, 'A': 0, 'B+': 0, 'B': 0, 'C+': 0, 'C': 0, 'F': 0
            };
            
            studentGrades.forEach(grade => {
                const percentage = calculatePercentage(grade.obtainedMarks, grade.totalMarks);
                const letterGrade = getLetterGrade(percentage);
                gradeCount[letterGrade]++;
            });
            
            const totalGrades = studentGrades.length;
            
            return Object.keys(gradeCount).map(grade => {
                const count = gradeCount[grade];
                const percentage = totalGrades > 0 ? Math.round((count / totalGrades) * 100) : 0;
                
                let barColor = 'bg-gray-300';
                if (grade === 'A+' || grade === 'A') barColor = 'bg-green-500';
                else if (grade === 'B+' || grade === 'B') barColor = 'bg-blue-500';
                else if (grade === 'C+' || grade === 'C') barColor = 'bg-yellow-500';
                else if (grade === 'F') barColor = 'bg-red-500';
                
                return `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center">
                            <span class="font-semibold text-sm w-8">${grade}</span>
                            <div class="w-24 bg-gray-200 rounded-full h-2 ml-3">
                                <div class="${barColor} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="text-sm font-medium text-gray-600">
                            ${count} (${percentage}%)
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateAttendanceBySubject(studentId, semester) {
            const myAttendance = attendance.filter(a => a.studentId === studentId);
            const semesterSubjects = getSubjectsForSemester(semester);
            
            if (semesterSubjects.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No subjects found for your semester</p>';
            }
            
            return semesterSubjects.map(subject => {
                const subjectAttendance = myAttendance.filter(a => a.subject === subject.value);
                const totalClasses = subjectAttendance.length;
                const presentClasses = subjectAttendance.filter(a => a.status === 'present').length;
                const attendanceRate = totalClasses > 0 ? Math.round((presentClasses / totalClasses) * 100) : 0;
                
                let barColor = 'bg-gray-300';
                if (attendanceRate >= 90) barColor = 'bg-green-500';
                else if (attendanceRate >= 75) barColor = 'bg-blue-500';
                else if (attendanceRate >= 60) barColor = 'bg-yellow-500';
                else barColor = 'bg-red-500';
                
                return `
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">${subject.name}</span>
                            <span class="font-semibold">${attendanceRate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full transition-all duration-500" style="width: ${attendanceRate}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${presentClasses}/${totalClasses} classes attended
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Admin Action Functions
        function updateStudent(event) {
            event.preventDefault();
            clearAllErrors('editStudentForm');
            
            const studentId = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value.trim();
            const email = document.getElementById('editStudentEmail').value.trim().toLowerCase();
            const course = document.getElementById('editStudentCourse').value;
            const semester = parseInt(document.getElementById('editStudentSemester').value);
            const phone = document.getElementById('editStudentPhone').value.trim();
            const status = document.getElementById('editStudentStatus').value;
            
            let hasErrors = false;
            
            // Validation
            if (!name || name.length < 2) {
                showFieldError('editStudentName', 'Name must be at least 2 characters');
                hasErrors = true;
            }
            
            if (!email || !validateEmail(email)) {
                showFieldError('editStudentEmail', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            // Check if email is already taken by another student
            const existingStudent = students.find(s => s.email.toLowerCase() === email && s.id !== studentId);
            if (existingStudent) {
                showFieldError('editStudentEmail', 'Email already exists! Please use a different email.');
                hasErrors = true;
            }
            
            if (!course) {
                showFieldError('editStudentCourse', 'Please select a course');
                hasErrors = true;
            }
            
            if (!semester || semester < 1 || semester > 6) {
                showFieldError('editStudentSemester', 'Please select a valid semester');
                hasErrors = true;
            }
            
            if (phone && !validatePhone(phone)) {
                showFieldError('editStudentPhone', 'Please enter a valid 10-digit phone number');
                hasErrors = true;
            }
            
            if (!status) {
                showFieldError('editStudentStatus', 'Please select a status');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const updateButton = document.getElementById('updateStudentButton');
            updateButton.disabled = true;
            updateButton.innerHTML = '<div class="loading-spinner mr-2"></div>Updating Student...';
            
            setTimeout(() => {
                // Find and update student
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex > -1) {
                    const oldEmail = students[studentIndex].email;
                    
                    students[studentIndex] = {
                        ...students[studentIndex],
                        name,
                        email,
                        course,
                        semester,
                        phone,
                        status,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Update corresponding user account
                    const userIndex = users.findIndex(u => u.email === oldEmail);
                    if (userIndex > -1) {
                        users[userIndex] = {
                            ...users[userIndex],
                            name,
                            email,
                            course,
                            semester,
                            updatedAt: new Date().toISOString()
                        };
                    }
                    
                    // Update attendance and marks records
                    attendance.forEach(record => {
                        if (record.studentId === studentId) {
                            record.updatedAt = new Date().toISOString();
                        }
                        if (record.markedBy === oldEmail) {
                            record.markedBy = email;
                        }
                    });
                    
                    marks.forEach(record => {
                        if (record.studentId === studentId) {
                            record.updatedAt = new Date().toISOString();
                        }
                        if (record.addedBy === oldEmail) {
                            record.addedBy = email;
                        }
                    });
                    
                    saveData();
                    showSuccess(`${name} updated successfully! 🎉`);
                    closeModal('editStudentModal');
                    
                    // Refresh current view
                    if (navigationHistory.length > 0) {
                        const currentPage = navigationHistory[navigationHistory.length - 1];
                        if (currentPage.page === 'viewStudent') {
                            viewStudent(studentId);
                        } else if (currentPage.page === 'students') {
                            document.getElementById('studentsTableBody').innerHTML = renderStudentsTable();
                        }
                    }
                } else {
                    showError('Student not found');
                }
                
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Student';
            }, 1500);
        }

        function toggleStudentStatus(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            const newStatus = student.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} ${student.name}?`)) {
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex > -1) {
                    students[studentIndex].status = newStatus;
                    students[studentIndex].updatedAt = new Date().toISOString();
                    
                    saveData();
                    showSuccess(`${student.name} ${action}d successfully!`);
                    
                    // Refresh current view
                    if (navigationHistory.length > 0) {
                        const currentPage = navigationHistory[navigationHistory.length - 1];
                        if (currentPage.page === 'viewStudent') {
                            viewStudent(studentId);
                        } else if (currentPage.page === 'students') {
                            document.getElementById('studentsTableBody').innerHTML = renderStudentsTable();
                        }
                    }
                }
            }
        }

        function editAttendance(attendanceId) {
            const attendanceRecord = attendance.find(a => a.id === attendanceId);
            if (!attendanceRecord) {
                showError('Attendance record not found');
                return;
            }
            
            const student = students.find(s => s.id === attendanceRecord.studentId);
            
            // Populate edit modal
            document.getElementById('editAttendanceId').value = attendanceRecord.id;
            document.getElementById('editAttendanceStudentName').value = student ? `${student.name} (${student.id})` : 'Unknown Student';
            document.getElementById('editAttendanceSubject').value = attendanceRecord.subject;
            document.getElementById('editAttendanceDate').value = attendanceRecord.date;
            document.getElementById('editAttendanceStatus').value = attendanceRecord.status;
            document.getElementById('editAttendanceTime').value = attendanceRecord.time || '';
            
            openModal('editAttendanceModal');
        }

        function updateAttendance(event) {
            event.preventDefault();
            clearAllErrors('editAttendanceForm');
            
            const attendanceId = parseInt(document.getElementById('editAttendanceId').value);
            const subject = document.getElementById('editAttendanceSubject').value;
            const date = document.getElementById('editAttendanceDate').value;
            const status = document.getElementById('editAttendanceStatus').value;
            const time = document.getElementById('editAttendanceTime').value;
            
            let hasErrors = false;
            
            if (!subject) {
                showFieldError('editAttendanceSubject', 'Please select a subject');
                hasErrors = true;
            }
            
            if (!date) {
                showFieldError('editAttendanceDate', 'Please select a date');
                hasErrors = true;
            }
            
            if (!status) {
                showFieldError('editAttendanceStatus', 'Please select a status');
                hasErrors = true;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const selectedDate = new Date(date);
            
            if (selectedDate > today) {
                showFieldError('editAttendanceDate', 'Cannot set attendance for future dates');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const updateButton = document.getElementById('updateAttendanceButton');
            updateButton.disabled = true;
            updateButton.innerHTML = '<div class="loading-spinner mr-2"></div>Updating Attendance...';
            
            setTimeout(() => {
                const attendanceIndex = attendance.findIndex(a => a.id === attendanceId);
                if (attendanceIndex > -1) {
                    attendance[attendanceIndex] = {
                        ...attendance[attendanceIndex],
                        subject,
                        date,
                        status,
                        time: time || null,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.email
                    };
                    
                    saveData();
                    showSuccess('Attendance updated successfully! 📅');
                    closeModal('editAttendanceModal');
                    
                    // Refresh current view
                    if (navigationHistory.length > 0) {
                        const currentPage = navigationHistory[navigationHistory.length - 1];
                        if (currentPage.page === 'viewStudent') {
                            viewStudent(currentPage.studentId);
                        } else if (currentPage.page === 'attendance') {
                            document.getElementById('attendanceTableBody').innerHTML = renderAttendanceTable();
                        }
                    }
                } else {
                    showError('Attendance record not found');
                }
                
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Attendance';
            }, 1000);
        }

        function editGrade(gradeId) {
            const gradeRecord = marks.find(m => m.id === gradeId);
            if (!gradeRecord) {
                showError('Grade record not found');
                return;
            }
            
            const student = students.find(s => s.id === gradeRecord.studentId);
            
            // Populate edit modal
            document.getElementById('editGradeId').value = gradeRecord.id;
            document.getElementById('editGradeStudentName').value = student ? `${student.name} (${student.id})` : 'Unknown Student';
            document.getElementById('editGradeSubject').value = gradeRecord.subject;
            document.getElementById('editGradeExamType').value = gradeRecord.examType;
            document.getElementById('editGradeDate').value = gradeRecord.date;
            document.getElementById('editGradeTotalMarks').value = gradeRecord.totalMarks;
            document.getElementById('editGradeObtainedMarks').value = gradeRecord.obtainedMarks;
            document.getElementById('editGradeVerified').value = gradeRecord.verified ? 'true' : 'false';
            
            openModal('editGradeModal');
        }

        function updateGrade(event) {
            event.preventDefault();
            clearAllErrors('editGradeForm');
            
            const gradeId = parseInt(document.getElementById('editGradeId').value);
            const subject = document.getElementById('editGradeSubject').value;
            const examType = document.getElementById('editGradeExamType').value;
            const date = document.getElementById('editGradeDate').value;
            const totalMarks = parseInt(document.getElementById('editGradeTotalMarks').value);
            const obtainedMarks = parseInt(document.getElementById('editGradeObtainedMarks').value);
            const verified = document.getElementById('editGradeVerified').value === 'true';
            
            let hasErrors = false;
            
            if (!subject) {
                showFieldError('editGradeSubject', 'Please select a subject');
                hasErrors = true;
            }
            
            if (!examType) {
                showFieldError('editGradeExamType', 'Please select an exam type');
                hasErrors = true;
            }
            
            if (!date) {
                showFieldError('editGradeDate', 'Please select a date');
                hasErrors = true;
            }
            
            if (!totalMarks || totalMarks < 1 || totalMarks > 1000) {
                showFieldError('editGradeTotalMarks', 'Total marks must be between 1 and 1000');
                hasErrors = true;
            }
            
            if (obtainedMarks === undefined || obtainedMarks < 0) {
                showFieldError('editGradeObtainedMarks', 'Obtained marks cannot be negative');
                hasErrors = true;
            }
            
            if (obtainedMarks > totalMarks) {
                showFieldError('editGradeObtainedMarks', 'Obtained marks cannot be greater than total marks');
                hasErrors = true;
            }
            
            // Check if date is not in the future
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const selectedDate = new Date(date);
            
            if (selectedDate > today) {
                showFieldError('editGradeDate', 'Cannot set grades for future dates');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            const updateButton = document.getElementById('updateGradeButton');
            updateButton.disabled = true;
            updateButton.innerHTML = '<div class="loading-spinner mr-2"></div>Updating Grade...';
            
            setTimeout(() => {
                const gradeIndex = marks.findIndex(m => m.id === gradeId);
                if (gradeIndex > -1) {
                    marks[gradeIndex] = {
                        ...marks[gradeIndex],
                        subject,
                        examType,
                        date,
                        totalMarks,
                        obtainedMarks,
                        verified,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.email
                    };
                    
                    saveData();
                    
                    const percentage = calculatePercentage(obtainedMarks, totalMarks);
                    const grade = getLetterGrade(percentage);
                    showSuccess(`Grade updated successfully! ${obtainedMarks}/${totalMarks} (${percentage}% - Grade ${grade}) 📊`);
                    closeModal('editGradeModal');
                    
                    // Refresh current view
                    if (navigationHistory.length > 0) {
                        const currentPage = navigationHistory[navigationHistory.length - 1];
                        if (currentPage.page === 'viewStudent') {
                            viewStudent(currentPage.studentId);
                        } else if (currentPage.page === 'grades') {
                            document.getElementById('gradesTableBody').innerHTML = renderGradesTable();
                            updateGradesStats();
                        }
                    }
                } else {
                    showError('Grade record not found');
                }
                
                updateButton.disabled = false;
                updateButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Grade';
            }, 1000);
        }

        function markStudentAttendance(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            // Pre-fill attendance form with student data
            document.getElementById('attendanceStudent').value = studentId;
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            
            // Navigate to attendance page
            showAttendance();
            
            // Scroll to mark attendance form
            setTimeout(() => {
                const form = document.querySelector('#attendanceStudent').closest('.card');
                if (form) {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
            
            showSuccess(`Ready to mark attendance for ${student.name}! 📝`);
        }

        function addStudentGrade(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            // Pre-fill grade form with student data
            document.getElementById('gradeStudent').value = studentId;
            document.getElementById('gradeDate').value = new Date().toISOString().split('T')[0];
            
            // Navigate to grades page
            showGrades();
            
            // Scroll to add grade form
            setTimeout(() => {
                const form = document.querySelector('#gradeStudent').closest('.card');
                if (form) {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
            
            showSuccess(`Ready to add grade for ${student.name}! 📊`);
        }

        function sendNotification(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            const message = prompt(`Send notification to ${student.name}:\n\nEnter your message:`);
            if (message && message.trim()) {
                // Simulate sending notification
                setTimeout(() => {
                    showSuccess(`📧 Notification sent to ${student.name}: "${message.trim()}"`);
                }, 1000);
            }
        }

        function generateStudentReport(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            try {
                const studentAttendance = attendance.filter(a => a.studentId === studentId);
                const studentGrades = marks.filter(m => m.studentId === studentId);
                const attendanceRate = calculateStudentAttendance(studentId);
                const cgpa = calculateCGPA(studentId);
                const semesterGPA = calculateSemesterGPA(studentId, student.semester);
                
                const reportData = {
                    student: {
                        id: student.id,
                        name: student.name,
                        email: student.email,
                        course: getCourseName(student.course),
                        semester: student.semester,
                        phone: student.phone,
                        status: student.status
                    },
                    performance: {
                        attendanceRate: attendanceRate,
                        overallCGPA: cgpa,
                        semesterGPA: semesterGPA,
                        totalGrades: studentGrades.length,
                        verifiedGrades: studentGrades.filter(g => g.verified).length,
                        pendingGrades: studentGrades.filter(g => g.selfReported && !g.verified).length
                    },
                    attendance: studentAttendance.map(a => ({
                        date: a.date,
                        subject: getSubjectName(a.subject),
                        status: a.status,
                        time: a.time,
                        markedBy: a.markedBy,
                        selfMarked: a.selfMarked
                    })),
                    grades: studentGrades.map(g => ({
                        date: g.date,
                        subject: getSubjectName(g.subject),
                        examType: formatExamType(g.examType),
                        totalMarks: g.totalMarks,
                        obtainedMarks: g.obtainedMarks,
                        percentage: calculatePercentage(g.obtainedMarks, g.totalMarks),
                        grade: getLetterGrade(calculatePercentage(g.obtainedMarks, g.totalMarks)),
                        gradePoints: getGradePoints(calculatePercentage(g.obtainedMarks, g.totalMarks)),
                        verified: g.verified,
                        selfReported: g.selfReported
                    })),
                    reportGenerated: new Date().toISOString(),
                    generatedBy: currentUser.email,
                    college: 'SREE SIDDRAMESHWARA POLYTECHNIC TIPTUR'
                };
                
                const dataStr = JSON.stringify(reportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `${student.name.replace(/\s+/g, '_')}_report_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccess(`📄 Report generated for ${student.name}! Download started.`);
            } catch (error) {
                showError('Failed to generate report. Please try again.');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977ac18cc07a3e03',t:'MTc1NjYyNDcyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
